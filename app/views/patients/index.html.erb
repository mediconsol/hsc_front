<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
  <!-- í˜ì´ì§€ í—¤ë” -->
  <div class="md:flex md:items-center md:justify-between">
    <div class="flex-1 min-w-0">
      <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
        ğŸ‘¥ í™˜ì ê´€ë¦¬
      </h2>
      <p class="mt-1 text-sm text-gray-500">
        ê±´ê°•ê²€ì§„ í™˜ì ì •ë³´ ê´€ë¦¬, ê²€ì§„ ì´ë ¥ ë° ê²°ê³¼ ì¡°íšŒ
      </p>
    </div>
    <div class="mt-4 md:mt-0">
      <button onclick="showCreatePatientModal()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">
        ì‹ ê·œ í™˜ì ë“±ë¡
      </button>
    </div>
  </div>

  <!-- í™˜ì ê´€ë¦¬ í†µê³„ -->
  <div class="mt-8">
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-5 mb-6">
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                <span class="text-white text-sm">ğŸ‘¥</span>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">ì „ì²´ í™˜ì</dt>
                <dd class="text-lg font-medium text-gray-900" id="total-patients-count">-</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
      
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                <span class="text-white text-sm">âœ…</span>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">í™œì„± í™˜ì</dt>
                <dd class="text-lg font-medium text-gray-900" id="active-patients-count">-</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
      
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                <span class="text-white text-sm">ğŸ†•</span>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">ì‹ ê·œ í™˜ì (ì´ë²ˆë‹¬)</dt>
                <dd class="text-lg font-medium text-gray-900" id="new-patients-count">-</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
      
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center">
                <span class="text-white text-sm">âš ï¸</span>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">ê²€ì§„ í•„ìš”</dt>
                <dd class="text-lg font-medium text-gray-900" id="needs-checkup-count">-</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
      
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center">
                <span class="text-white text-sm">ğŸ“Š</span>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">í‰ê·  ì—°ë ¹</dt>
                <dd class="text-lg font-medium text-gray-900" id="average-age">-</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ê²€ìƒ‰ ë° í•„í„° -->
  <div class="bg-white shadow sm:rounded-md mb-6">
    <div class="px-6 py-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- í†µí•© ê²€ìƒ‰ -->
        <div class="md:col-span-2">
          <label for="patient-search" class="block text-sm font-medium text-gray-700">í™˜ì ê²€ìƒ‰</label>
          <div class="mt-1 relative">
            <input type="text" id="patient-search" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="í™˜ìëª…, ì°¨íŠ¸ë²ˆí˜¸, ì „í™”ë²ˆí˜¸ ì…ë ¥">
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
              <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
          </div>
        </div>
        
        <!-- ì„±ë³„ í•„í„° -->
        <div>
          <label for="gender-filter" class="block text-sm font-medium text-gray-700">ì„±ë³„</label>
          <select id="gender-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
            <option value="">ì „ì²´</option>
            <option value="male">ë‚¨ì„±</option>
            <option value="female">ì—¬ì„±</option>
          </select>
        </div>
        
        <!-- ë‚˜ì´ëŒ€ í•„í„° -->
        <div>
          <label for="age-filter" class="block text-sm font-medium text-gray-700">ë‚˜ì´ëŒ€</label>
          <select id="age-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
            <option value="">ì „ì²´</option>
            <option value="20-29">20ëŒ€</option>
            <option value="30-39">30ëŒ€</option>
            <option value="40-49">40ëŒ€</option>
            <option value="50-59">50ëŒ€</option>
            <option value="60-69">60ëŒ€</option>
            <option value="70-999">70ì„¸ ì´ìƒ</option>
          </select>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
        <!-- ë³´í—˜ìœ í˜• í•„í„° -->
        <div>
          <label for="insurance-filter" class="block text-sm font-medium text-gray-700">ë³´í—˜ìœ í˜•</label>
          <select id="insurance-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
            <option value="">ì „ì²´</option>
            <option value="national">ê±´ê°•ë³´í—˜</option>
            <option value="employee">ì§ì¥ë³´í—˜</option>
            <option value="medical_aid">ì˜ë£Œê¸‰ì—¬</option>
            <option value="private">ì‹¤ì†ë³´í—˜</option>
            <option value="none">ë¬´ë³´í—˜</option>
          </select>
        </div>
        
        <!-- ìƒíƒœ í•„í„° -->
        <div>
          <label for="status-filter" class="block text-sm font-medium text-gray-700">ìƒíƒœ</label>
          <select id="status-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
            <option value="">ì „ì²´</option>
            <option value="active">í™œì„±</option>
            <option value="inactive">ë¹„í™œì„±</option>
            <option value="blocked">ì°¨ë‹¨</option>
          </select>
        </div>
        
        <!-- ê²€ì§„í•„ìš” í•„í„° -->
        <div>
          <label for="checkup-filter" class="block text-sm font-medium text-gray-700">ê²€ì§„ìƒíƒœ</label>
          <select id="checkup-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
            <option value="">ì „ì²´</option>
            <option value="needs">ê²€ì§„í•„ìš”</option>
            <option value="recent">ìµœê·¼ê²€ì§„ì™„ë£Œ</option>
          </select>
        </div>
        
        <!-- ì •ë ¬ -->
        <div>
          <label for="sort-filter" class="block text-sm font-medium text-gray-700">ì •ë ¬</label>
          <select id="sort-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
            <option value="recent">ìµœê·¼ ë“±ë¡ìˆœ</option>
            <option value="name">ì´ë¦„ìˆœ</option>
            <option value="checkup">ìµœê·¼ ê²€ì§„ìˆœ</option>
          </select>
        </div>
      </div>
      
      <div class="mt-4 flex justify-between">
        <button onclick="resetFilters()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
          í•„í„° ì´ˆê¸°í™”
        </button>
        <button onclick="searchPatients()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">
          ê²€ìƒ‰
        </button>
      </div>
    </div>
  </div>
  
  <!-- í™˜ì ëª©ë¡ -->
  <div class="bg-white shadow sm:rounded-md">
    <div class="px-6 py-4 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900">í™˜ì ëª©ë¡</h3>
        <div class="text-sm text-gray-500">
          ì´ <span id="total-count">0</span>ëª…
        </div>
      </div>
    </div>
    
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì´ë¦„</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì°¨íŠ¸ë²ˆí˜¸</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì—°ë ¹</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì„±ë³„</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì—°ë½ì²˜</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë³´í—˜ì •ë³´</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìµœê·¼ ê²€ì§„</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìƒíƒœ</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì‘ì—…</th>
          </tr>
        </thead>
        <tbody id="patients-table-body" class="bg-white divide-y divide-gray-200">
          <!-- í™˜ì ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </tbody>
      </table>
    </div>
    
    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
      <div class="flex-1 flex justify-between sm:hidden">
        <button id="prev-btn-mobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" onclick="prevPage()">
          ì´ì „
        </button>
        <button id="next-btn-mobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" onclick="nextPage()">
          ë‹¤ìŒ
        </button>
      </div>
      <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
        <div>
          <p class="text-sm text-gray-700">
            <span id="pagination-info">1-20 of 100 results</span>
          </p>
        </div>
        <div>
          <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" id="pagination-controls">
            <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ì‹ ê·œ í™˜ì ë“±ë¡ ëª¨ë‹¬ -->
<div id="patient-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-medium text-gray-900" id="patient-modal-title">ì‹ ê·œ í™˜ì ë“±ë¡</h3>
          <button onclick="closePatientModal()" class="text-gray-400 hover:text-gray-500">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        
        <form id="patient-form">
          <div class="space-y-4">
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="patient-name" class="block text-sm font-medium text-gray-700">í™˜ìëª… *</label>
                <input type="text" id="patient-name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              </div>
              <div>
                <label for="patient-birth-date" class="block text-sm font-medium text-gray-700">ìƒë…„ì›”ì¼ *</label>
                <input type="date" id="patient-birth-date" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="patient-gender" class="block text-sm font-medium text-gray-700">ì„±ë³„ *</label>
                <select id="patient-gender" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                  <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                  <option value="male">ë‚¨ì„±</option>
                  <option value="female">ì—¬ì„±</option>
                </select>
              </div>
              <div>
                <label for="patient-phone" class="block text-sm font-medium text-gray-700">ì „í™”ë²ˆí˜¸ *</label>
                <input type="tel" id="patient-phone" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="010-1234-5678">
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="patient-email" class="block text-sm font-medium text-gray-700">ì´ë©”ì¼</label>
                <input type="email" id="patient-email" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              </div>
              <div>
                <label for="patient-occupation" class="block text-sm font-medium text-gray-700">ì§ì—…</label>
                <input type="text" id="patient-occupation" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              </div>
            </div>
            
            <!-- ë³´í—˜ ì •ë³´ -->
            <div class="border-t pt-4">
              <h4 class="text-md font-medium text-gray-900 mb-3">ë³´í—˜ ì •ë³´</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="patient-insurance-type" class="block text-sm font-medium text-gray-700">ë³´í—˜ ìœ í˜•</label>
                  <select id="patient-insurance-type" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="national">ê±´ê°•ë³´í—˜</option>
                    <option value="employee">ì§ì¥ë³´í—˜</option>
                    <option value="medical_aid">ì˜ë£Œê¸‰ì—¬</option>
                    <option value="private">ì‹¤ì†ë³´í—˜</option>
                    <option value="none">ë¬´ë³´í—˜</option>
                  </select>
                </div>
                <div>
                  <label for="patient-insurance-number" class="block text-sm font-medium text-gray-700">ë³´í—˜ ë²ˆí˜¸</label>
                  <input type="text" id="patient-insurance-number" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
              </div>
            </div>
            
            <!-- ì‘ê¸‰ ì—°ë½ì²˜ -->
            <div class="border-t pt-4">
              <h4 class="text-md font-medium text-gray-900 mb-3">ì‘ê¸‰ ì—°ë½ì²˜</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="emergency-contact-name" class="block text-sm font-medium text-gray-700">ì´ë¦„</label>
                  <input type="text" id="emergency-contact-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                  <label for="emergency-contact-phone" class="block text-sm font-medium text-gray-700">ì „í™”ë²ˆí˜¸</label>
                  <input type="tel" id="emergency-contact-phone" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
              </div>
            </div>
            
            <div>
              <label for="patient-address" class="block text-sm font-medium text-gray-700">ì£¼ì†Œ</label>
              <textarea id="patient-address" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
            </div>
            
            <div>
              <label for="patient-notes" class="block text-sm font-medium text-gray-700">íŠ¹ì´ì‚¬í•­</label>
              <textarea id="patient-notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
            </div>
          </div>
          
          <div class="flex items-center justify-end pt-6 space-x-3">
            <button type="button" onclick="closePatientModal()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
              ì·¨ì†Œ
            </button>
            <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
              ë“±ë¡
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- í™˜ì ìƒì„¸ ëª¨ë‹¬ -->
<div id="patient-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full max-h-screen overflow-y-auto">
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-medium text-gray-900">í™˜ì ìƒì„¸ ì •ë³´</h3>
          <button onclick="closePatientDetailModal()" class="text-gray-400 hover:text-gray-500">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        
        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="border-b border-gray-200 mb-6">
          <nav class="-mb-px flex space-x-8">
            <a href="#" onclick="showPatientTab('basic')" class="patient-tab-link active border-blue-500 text-blue-600 py-2 px-1 border-b-2 font-medium text-sm" data-tab="basic">
              ê¸°ë³¸ ì •ë³´
            </a>
            <a href="#" onclick="showPatientTab('checkups')" class="patient-tab-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 border-b-2 font-medium text-sm" data-tab="checkups">
              ê²€ì§„ ì´ë ¥
            </a>
            <a href="#" onclick="showPatientTab('results')" class="patient-tab-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 border-b-2 font-medium text-sm" data-tab="results">
              ê²€ì§„ ê²°ê³¼
            </a>
            <a href="#" onclick="showPatientTab('medical')" class="patient-tab-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 border-b-2 font-medium text-sm" data-tab="medical">
              ì˜ë£Œ ì •ë³´
            </a>
            <a href="#" onclick="showPatientTab('appointments')" class="patient-tab-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 border-b-2 font-medium text-sm" data-tab="appointments">
              ì˜ˆì•½ ê´€ë¦¬
            </a>
            <a href="#" onclick="showPatientTab('documents')" class="patient-tab-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 border-b-2 font-medium text-sm" data-tab="documents">
              ë¬¸ì„œ/ì²­êµ¬
            </a>
          </nav>
        </div>
        
        <!-- íƒ­ ì»¨í…ì¸  -->
        <div id="patient-detail-content">
          <!-- íƒ­ë³„ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// í˜„ì¬ í˜ì´ì§€ ìƒíƒœ
let currentPage = 1;
let currentFilters = {};
let totalPages = 1;

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', async () => {
  try {
    await loadPatientStatistics();
    await searchPatients();
  } catch (error) {
    console.error('í™˜ì ê´€ë¦¬ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
    toast.error('í™˜ì ê´€ë¦¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
});

// í™˜ì í†µê³„ ë¡œë“œ (Mock ë°ì´í„°)
async function loadPatientStatistics() {
  try {
    // ì‹¤ì œ APIê°€ ì—†ìœ¼ë¯€ë¡œ Mock ë°ì´í„° ì‚¬ìš©
    document.getElementById('total-patients-count').textContent = '1,234';
    document.getElementById('active-patients-count').textContent = '1,180';
    document.getElementById('new-patients-count').textContent = '45';
    document.getElementById('needs-checkup-count').textContent = '156';
    document.getElementById('average-age').textContent = '45ì„¸';
  } catch (error) {
    console.error('í™˜ì í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
  }
}

// í™˜ì ê²€ìƒ‰ (Mock ë°ì´í„°)
async function searchPatients() {
  try {
    loading.show('í™˜ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
    
    // Mock ë°ì´í„° ìƒì„±
    const mockPatients = [
      {
        id: 1,
        patient_number: 'P2411001',
        name: 'ê¹€ì² ìˆ˜',
        age: 45,
        gender_text: 'ë‚¨ì„±',
        phone: '010-1234-5678',
        insurance_type_text: 'ê±´ê°•ë³´í—˜',
        last_checkup_date: '2024-03-15',
        needs_checkup: false,
        status_text: 'í™œì„±',
        status: 'active',
        next_appointment: null
      },
      {
        id: 2,
        patient_number: 'P2411002',
        name: 'ë°•ì˜í¬',
        age: 38,
        gender_text: 'ì—¬ì„±',
        phone: '010-9876-5432',
        insurance_type_text: 'ì§ì¥ë³´í—˜',
        last_checkup_date: '2023-12-10',
        needs_checkup: true,
        status_text: 'í™œì„±',
        status: 'active',
        next_appointment: '2024-12-15'
      },
      {
        id: 3,
        patient_number: 'P2411003',
        name: 'ì´ë¯¼ìˆ˜',
        age: 52,
        gender_text: 'ë‚¨ì„±',
        phone: '010-5555-1111',
        insurance_type_text: 'ê±´ê°•ë³´í—˜',
        last_checkup_date: '2024-08-20',
        needs_checkup: false,
        status_text: 'í™œì„±',
        status: 'active',
        next_appointment: null
      }
    ];
    
    // ê²€ìƒ‰ í•„í„° ì ìš© (ê°„ë‹¨í•œ ì˜ˆì‹œ)
    const searchTerm = document.getElementById('patient-search').value.toLowerCase();
    let filteredPatients = mockPatients;
    
    if (searchTerm) {
      filteredPatients = mockPatients.filter(patient => 
        patient.name.includes(searchTerm) || 
        patient.patient_number.toLowerCase().includes(searchTerm) ||
        patient.phone.includes(searchTerm)
      );
    }
    
    displayPatients(filteredPatients);
    
    // Mock í˜ì´ì§€ë„¤ì´ì…˜
    const mockPagination = {
      current_page: 1,
      total_pages: 1,
      total_count: filteredPatients.length,
      per_page: 20
    };
    
    updatePagination(mockPagination);
    document.getElementById('total-count').textContent = filteredPatients.length;
    
  } catch (error) {
    console.error('í™˜ì ê²€ìƒ‰ ì˜¤ë¥˜:', error);
    toast.error('í™˜ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  } finally {
    loading.hide();
  }
}

// í™˜ì ëª©ë¡ í‘œì‹œ
function displayPatients(patients) {
  const tbody = document.getElementById('patients-table-body');
  
  if (!patients || patients.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    return;
  }
  
  const html = patients.map(patient => `
    <tr class="hover:bg-gray-50 cursor-pointer" onclick="viewPatientDetail(${patient.id})">
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center">
              <span class="text-gray-600 font-medium">${patient.name.charAt(0)}</span>
            </div>
          </div>
          <div class="ml-4">
            <div class="text-sm font-medium text-gray-900">${patient.name}</div>
            <div class="text-sm text-gray-500">ì°¨íŠ¸ë²ˆí˜¸: ${patient.patient_number || '-'}</div>
          </div>
        </div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="text-sm text-gray-900">${patient.age}ì„¸</div>
        <div class="text-sm text-gray-500">${patient.gender_text}</div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="text-sm text-gray-900">ğŸ“ ${patient.phone}</div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="text-sm text-gray-900">${patient.insurance_type_text}</div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="text-sm text-gray-900">${patient.last_checkup_date || '-'}</div>
        ${patient.needs_checkup ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 mt-1">ê²€ì§„í•„ìš”</span>' : ''}
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${patient.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
          ${patient.status_text}
        </span>
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
        <div class="flex space-x-2">
          <button onclick="event.stopPropagation(); viewPatientDetail(${patient.id})" class="text-indigo-600 hover:text-indigo-900">ìƒì„¸</button>
          <button onclick="event.stopPropagation(); editPatient(${patient.id})" class="text-blue-600 hover:text-blue-900">ìˆ˜ì •</button>
          ${patient.next_appointment ? '' : '<button onclick="event.stopPropagation(); createAppointmentForPatient(' + patient.id + ')" class="text-green-600 hover:text-green-900">ì˜ˆì•½</button>'}
        </div>
      </td>
    </tr>
  `).join('');
  
  tbody.innerHTML = html;
}

// í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
function updatePagination(pagination) {
  totalPages = pagination.total_pages;
  currentPage = pagination.current_page;
  
  const info = document.getElementById('pagination-info');
  const start = ((currentPage - 1) * pagination.per_page) + 1;
  const end = Math.min(currentPage * pagination.per_page, pagination.total_count);
  info.textContent = `${start}-${end} of ${pagination.total_count} results`;
}

// í•„í„° ì´ˆê¸°í™”
function resetFilters() {
  document.getElementById('patient-search').value = '';
  document.getElementById('gender-filter').value = '';
  document.getElementById('age-filter').value = '';
  document.getElementById('insurance-filter').value = '';
  document.getElementById('status-filter').value = '';
  document.getElementById('checkup-filter').value = '';
  document.getElementById('sort-filter').value = 'recent';
  
  currentPage = 1;
  searchPatients();
}

// ì‹¤ì‹œê°„ ê²€ìƒ‰
document.getElementById('patient-search').addEventListener('input', function() {
  clearTimeout(this.searchTimer);
  this.searchTimer = setTimeout(() => {
    currentPage = 1;
    searchPatients();
  }, 500);
});

// ì‹ ê·œ í™˜ì ë“±ë¡ ëª¨ë‹¬ í‘œì‹œ
function showCreatePatientModal() {
  document.getElementById('patient-modal-title').textContent = 'ì‹ ê·œ í™˜ì ë“±ë¡';
  document.getElementById('patient-form').reset();
  document.getElementById('patient-modal').classList.remove('hidden');
}

// í™˜ì ë“±ë¡ ëª¨ë‹¬ ë‹«ê¸°
function closePatientModal() {
  document.getElementById('patient-modal').classList.add('hidden');
}

// í™˜ì ë“±ë¡ í¼ ì œì¶œ
document.getElementById('patient-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  // Mock ë“±ë¡ ì²˜ë¦¬
  toast.success('í™˜ìê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
  closePatientModal();
  await loadPatientStatistics();
  await searchPatients();
});

// í™˜ì ìƒì„¸ ì •ë³´ ë³´ê¸°
async function viewPatientDetail(patientId) {
  // Mock í™˜ì ë°ì´í„°
  const mockPatient = {
    id: patientId,
    patient_number: 'P2411001',
    name: 'ê¹€ì² ìˆ˜',
    age: 45,
    gender_text: 'ë‚¨ì„±',
    birth_date: '1979-05-15',
    phone: '010-1234-5678',
    email: 'kim@example.com',
    occupation: 'íšŒì‚¬ì›',
    insurance_type_text: 'ê±´ê°•ë³´í—˜',
    insurance_number: '12345678901',
    emergency_contact_name: 'ê¹€ì˜í¬',
    emergency_contact_phone: '010-9876-5432',
    address: 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123',
    status_text: 'í™œì„±',
    status_color: 'bg-green-100 text-green-800',
    notes: 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ',
    height: 175,
    weight: 70,
    bmi: 22.9,
    bmi_status: 'ì •ìƒ',
    blood_type: 'A+',
    smoking_status_text: 'ë¹„í¡ì—°',
    drinking_status_text: 'ê°€ë”',
    exercise_status_text: 'ê·œì¹™ì '
  };
  
  showPatientDetailModal(mockPatient);
}

// í™˜ì ìƒì„¸ ëª¨ë‹¬ í‘œì‹œ
function showPatientDetailModal(patient) {
  document.getElementById('patient-detail-modal').classList.remove('hidden');
  window.currentPatient = patient;
  showPatientTab('basic');
}

// í™˜ì IDë¡œ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
function openPatientDetailModal(patientId) {
  const patient = currentPatientList.find(p => p.id === patientId);
  if (patient) {
    showPatientDetailModal(patient);
  } else {
    window.toast.error('í™˜ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
}

// í™˜ì ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
function closePatientDetailModal() {
  document.getElementById('patient-detail-modal').classList.add('hidden');
  window.currentPatient = null;
}

// í™˜ì ìƒì„¸ íƒ­ ì „í™˜
function showPatientTab(tabName) {
  // íƒ­ ë§í¬ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
  document.querySelectorAll('.patient-tab-link').forEach(link => {
    link.classList.remove('border-blue-500', 'text-blue-600');
    link.classList.add('border-transparent', 'text-gray-500');
  });
  
  const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
  activeTab.classList.remove('border-transparent', 'text-gray-500');
  activeTab.classList.add('border-blue-500', 'text-blue-600');
  
  // íƒ­ ë‚´ìš© í‘œì‹œ
  const content = document.getElementById('patient-detail-content');
  
  switch (tabName) {
    case 'basic':
      content.innerHTML = renderBasicInfo(window.currentPatient);
      break;
    case 'checkups':
      content.innerHTML = renderCheckupHistory(window.currentPatient);
      break;
    case 'results':
      content.innerHTML = renderCheckupResults(window.currentPatient);
      break;
    case 'medical':
      content.innerHTML = renderMedicalInfo(window.currentPatient);
      break;
    case 'appointments':
      content.innerHTML = renderAppointments(window.currentPatient);
      break;
    case 'documents':
      content.innerHTML = renderDocuments(window.currentPatient);
      break;
  }
}

// ê¸°ë³¸ ì •ë³´ ë Œë”ë§
function renderBasicInfo(patient) {
  return `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="space-y-4">
        <h4 class="text-md font-semibold text-gray-900">ê°œì¸ ì •ë³´</h4>
        <div class="bg-gray-50 p-4 rounded-lg space-y-3">
          <div><span class="font-medium">ì´ë¦„:</span> ${patient.name}</div>
          <div><span class="font-medium">ì°¨íŠ¸ë²ˆí˜¸:</span> ${patient.patient_number || '-'}</div>
          <div><span class="font-medium">ë‚˜ì´/ì„±ë³„:</span> ${patient.age}ì„¸ / ${patient.gender_text}</div>
          <div><span class="font-medium">ìƒë…„ì›”ì¼:</span> ${patient.birth_date}</div>
          <div><span class="font-medium">ì „í™”ë²ˆí˜¸:</span> ${patient.phone}</div>
          <div><span class="font-medium">ì´ë©”ì¼:</span> ${patient.email || '-'}</div>
          <div><span class="font-medium">ì§ì—…:</span> ${patient.occupation || '-'}</div>
        </div>
      </div>
      
      <div class="space-y-4">
        <h4 class="text-md font-semibold text-gray-900">ë³´í—˜ ë° ê¸°íƒ€ ì •ë³´</h4>
        <div class="bg-gray-50 p-4 rounded-lg space-y-3">
          <div><span class="font-medium">ë³´í—˜ìœ í˜•:</span> ${patient.insurance_type_text}</div>
          <div><span class="font-medium">ë³´í—˜ë²ˆí˜¸:</span> ${patient.insurance_number || '-'}</div>
          <div><span class="font-medium">ì‘ê¸‰ì—°ë½ì²˜:</span> ${patient.emergency_contact_name || '-'} (${patient.emergency_contact_phone || '-'})</div>
          <div><span class="font-medium">ì£¼ì†Œ:</span> ${patient.address || '-'}</div>
          <div><span class="font-medium">ìƒíƒœ:</span> <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${patient.status_color}">${patient.status_text}</span></div>
        </div>
      </div>
    </div>
    
    ${patient.notes ? `
    <div class="mt-6">
      <h4 class="text-md font-semibold text-gray-900 mb-2">íŠ¹ì´ì‚¬í•­</h4>
      <div class="bg-gray-50 p-4 rounded-lg">
        <p class="text-sm text-gray-700">${patient.notes}</p>
      </div>
    </div>
    ` : ''}
  `;
}

// ê²€ì§„ ì´ë ¥ ë Œë”ë§
function renderCheckupHistory(patient) {
  return `
    <div class="space-y-4">
      <div class="flex justify-between items-center">
        <h4 class="text-md font-semibold text-gray-900">ê²€ì§„ ì´ë ¥</h4>
        <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">ìƒˆ ê²€ì§„ ë“±ë¡</button>
      </div>
      
      <div class="space-y-4">
        <div class="bg-white border rounded-lg p-4">
          <div class="flex justify-between items-start">
            <div>
              <h5 class="font-medium text-gray-900">ì¢…í•© ê±´ê°•ê²€ì§„</h5>
              <p class="text-sm text-gray-600 mt-1">2024ë…„ 03ì›” 15ì¼</p>
              <p class="text-sm text-gray-500">ë‹´ë‹¹ì˜: ê¹€ì˜ì‚¬</p>
            </div>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
              ì™„ë£Œ
            </span>
          </div>
          <div class="mt-3 flex space-x-3">
            <button class="text-blue-600 hover:text-blue-900 text-sm">ê²°ê³¼ ë³´ê¸°</button>
            <button class="text-green-600 hover:text-green-900 text-sm">PDF ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </div>
        
        <div class="bg-white border rounded-lg p-4">
          <div class="flex justify-between items-start">
            <div>
              <h5 class="font-medium text-gray-900">ì¼ë°˜ ê±´ê°•ê²€ì§„</h5>
              <p class="text-sm text-gray-600 mt-1">2023ë…„ 03ì›” 20ì¼</p>
              <p class="text-sm text-gray-500">ë‹´ë‹¹ì˜: ë°•ì˜ì‚¬</p>
            </div>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
              ì™„ë£Œ
            </span>
          </div>
          <div class="mt-3 flex space-x-3">
            <button class="text-blue-600 hover:text-blue-900 text-sm">ê²°ê³¼ ë³´ê¸°</button>
            <button class="text-green-600 hover:text-green-900 text-sm">PDF ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ê²€ì§„ ê²°ê³¼ ë Œë”ë§
function renderCheckupResults(patient) {
  return `
    <div class="space-y-4">
      <h4 class="text-md font-semibold text-gray-900">ìµœê·¼ ê²€ì§„ ê²°ê³¼ (2024.03.15)</h4>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="space-y-4">
          <h5 class="font-medium text-gray-900">í˜ˆì•¡ ê²€ì‚¬</h5>
          <div class="bg-gray-50 p-4 rounded-lg space-y-2">
            <div class="flex justify-between">
              <span class="text-sm">ì´ ì½œë ˆìŠ¤í…Œë¡¤</span>
              <span class="text-sm font-medium text-green-600">180 mg/dL (ì •ìƒ)</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm">í˜ˆë‹¹</span>
              <span class="text-sm font-medium text-green-600">95 mg/dL (ì •ìƒ)</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm">í˜ˆì••</span>
              <span class="text-sm font-medium text-yellow-600">130/85 mmHg (ê²½ê³„)</span>
            </div>
          </div>
        </div>
        
        <div class="space-y-4">
          <h5 class="font-medium text-gray-900">ì‹ ì²´ ê³„ì¸¡</h5>
          <div class="bg-gray-50 p-4 rounded-lg space-y-2">
            <div class="flex justify-between">
              <span class="text-sm">ì‹ ì¥</span>
              <span class="text-sm font-medium">175 cm</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm">ì²´ì¤‘</span>
              <span class="text-sm font-medium">70 kg</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm">BMI</span>
              <span class="text-sm font-medium text-green-600">22.9 (ì •ìƒ)</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="mt-6">
        <h5 class="font-medium text-gray-900 mb-2">ì¢…í•© ì†Œê²¬</h5>
        <div class="bg-gray-50 p-4 rounded-lg">
          <p class="text-sm text-gray-700">ì „ì²´ì ìœ¼ë¡œ ì–‘í˜¸í•œ ìƒíƒœì…ë‹ˆë‹¤. í˜ˆì••ì´ ì•½ê°„ ë†’ì€ í¸ì´ë¯€ë¡œ ì—¼ë¶„ ì„­ì·¨ë¥¼ ì¤„ì´ê³  ê·œì¹™ì ì¸ ìš´ë™ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>
  `;
}

// ì˜ë£Œ ì •ë³´ ë Œë”ë§
function renderMedicalInfo(patient) {
  return `
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="space-y-4">
        <h4 class="text-md font-semibold text-gray-900">ê±´ê°• ì •ë³´</h4>
        <div class="bg-gray-50 p-4 rounded-lg space-y-3">
          <div><span class="font-medium">ì‹ ì¥:</span> ${patient.height ? patient.height + 'cm' : '-'}</div>
          <div><span class="font-medium">ì²´ì¤‘:</span> ${patient.weight ? patient.weight + 'kg' : '-'}</div>
          <div><span class="font-medium">BMI:</span> ${patient.bmi || '-'} ${patient.bmi_status ? `(${patient.bmi_status})` : ''}</div>
          <div><span class="font-medium">í˜ˆì•¡í˜•:</span> ${patient.blood_type || '-'}</div>
          <div><span class="font-medium">í¡ì—°:</span> ${patient.smoking_status_text || '-'}</div>
          <div><span class="font-medium">ìŒì£¼:</span> ${patient.drinking_status_text || '-'}</div>
          <div><span class="font-medium">ìš´ë™:</span> ${patient.exercise_status_text || '-'}</div>
        </div>
      </div>
      
      <div class="space-y-4">
        <h4 class="text-md font-semibold text-gray-900">ê³¼ê±° ë³‘ë ¥</h4>
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium">ê³ í˜ˆì••</span>
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">ê´€ì°°ì¤‘</span>
            </div>
            <p class="text-xs text-gray-600">2023ë…„ ì§„ë‹¨, ì•½ë¬¼ ì¹˜ë£Œ ì¤‘</p>
          </div>
        </div>
        
        <h4 class="text-md font-semibold text-gray-900">ê°€ì¡±ë ¥</h4>
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="space-y-2">
            <div class="text-sm"><span class="font-medium">ë¶€:</span> ë‹¹ë‡¨ë³‘</div>
            <div class="text-sm"><span class="font-medium">ëª¨:</span> ê³ í˜ˆì••</div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ì˜ˆì•½ ê´€ë¦¬ ë Œë”ë§
function renderAppointments(patient) {
  return `
    <div class="space-y-4">
      <div class="flex justify-between items-center">
        <h4 class="text-md font-semibold text-gray-900">ì˜ˆì•½ ê´€ë¦¬</h4>
        <button onclick="createAppointmentForPatient(${patient.id})" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">ìƒˆ ì˜ˆì•½ ë“±ë¡</button>
      </div>
      
      <div class="space-y-4">
        <h5 class="font-medium text-gray-900">ì˜ˆì•½ ì´ë ¥</h5>
        <div class="bg-white border rounded-lg p-4">
          <div class="flex justify-between items-start">
            <div>
              <h6 class="font-medium text-gray-900">ì •ê¸° ê²€ì§„</h6>
              <p class="text-sm text-gray-600 mt-1">2024ë…„ 12ì›” 15ì¼ ì˜¤ì „ 10:00</p>
              <p class="text-sm text-gray-500">ë‹´ë‹¹ì˜: ê¹€ì˜ì‚¬</p>
            </div>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
              ì˜ˆì •
            </span>
          </div>
          <div class="mt-3 flex space-x-3">
            <button class="text-blue-600 hover:text-blue-900 text-sm">ë³€ê²½</button>
            <button class="text-red-600 hover:text-red-900 text-sm">ì·¨ì†Œ</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ë¬¸ì„œ/ì²­êµ¬ ë Œë”ë§
function renderDocuments(patient) {
  return `
    <div class="space-y-4">
      <h4 class="text-md font-semibold text-gray-900">ë¬¸ì„œ ë° ì²­êµ¬</h4>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gray-50 p-4 rounded-lg">
          <h5 class="font-medium text-gray-900 mb-2">ê²€ì§„ ê²°ê³¼ì„œ</h5>
          <p class="text-sm text-gray-600 mb-3">PDF í˜•íƒœì˜ ê²€ì§„ ê²°ê³¼ì„œë¥¼ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-sm">2024ë…„ ì¢…í•©ê²€ì§„</span>
              <button class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">ë‹¤ìš´ë¡œë“œ</button>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm">2023ë…„ ì¼ë°˜ê²€ì§„</span>
              <button class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">ë‹¤ìš´ë¡œë“œ</button>
            </div>
          </div>
        </div>
        
        <div class="bg-gray-50 p-4 rounded-lg">
          <h5 class="font-medium text-gray-900 mb-2">ì²­êµ¬/ìˆ˜ë‚© ë‚´ì—­</h5>
          <p class="text-sm text-gray-600 mb-3">ê²€ì§„ ë¹„ìš© ë° ìˆ˜ë‚© ë‚´ì—­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-sm">2024.03.15 ì¢…í•©ê²€ì§„</span>
              <span class="text-sm font-medium text-green-600">ìˆ˜ë‚©ì™„ë£Œ</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm">2023.03.20 ì¼ë°˜ê²€ì§„</span>
              <span class="text-sm font-medium text-green-600">ìˆ˜ë‚©ì™„ë£Œ</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// í™˜ì ìˆ˜ì •
function editPatient(patientId) {
  toast.info('í™˜ì ìˆ˜ì • ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.');
}

// í™˜ìë¥¼ ìœ„í•œ ì˜ˆì•½ ìƒì„±
function createAppointmentForPatient(patientId) {
  // ì˜ˆì•½/ì ‘ìˆ˜ í˜ì´ì§€ë¡œ ì´ë™í•˜ë©´ì„œ í™˜ì ID ì „ë‹¬
  window.location.href = `/appointments?patient_id=${patientId}`;
}

// ì‹¤ì œ ê²€ìƒ‰ ë° í•„í„°ë§ ê¸°ëŠ¥ ê°•í™”
let currentPatientList = [];
let filteredPatientList = [];
let currentSearchTerm = '';

// ê²€ìƒ‰ ê¸°ëŠ¥ ê°•í™”
function handleSearch() {
  const searchInput = document.getElementById('searchInput');
  const searchTerm = searchInput.value.toLowerCase().trim();
  currentSearchTerm = searchTerm;
  
  if (searchTerm === '') {
    filteredPatientList = [...currentPatientList];
  } else {
    filteredPatientList = currentPatientList.filter(patient => {
      return patient.name.toLowerCase().includes(searchTerm) ||
             patient.patient_number.toLowerCase().includes(searchTerm) ||
             patient.phone.includes(searchTerm) ||
             (patient.email && patient.email.toLowerCase().includes(searchTerm));
    });
  }
  
  applyAllFilters();
  updatePatientDisplay();
}

// í•„í„° ì ìš© ê¸°ëŠ¥
function applyAllFilters() {
  let filtered = [...filteredPatientList];
  
  // ì„±ë³„ í•„í„°
  const genderFilter = document.getElementById('genderFilter').value;
  if (genderFilter) {
    filtered = filtered.filter(p => p.gender === genderFilter);
  }
  
  // ì—°ë ¹ëŒ€ í•„í„°
  const ageFilter = document.getElementById('ageFilter').value;
  if (ageFilter) {
    const [minAge, maxAge] = ageFilter.split('-').map(Number);
    filtered = filtered.filter(p => {
      const age = calculateAge(p.birth_date);
      if (maxAge) {
        return age >= minAge && age <= maxAge;
      } else {
        return age >= minAge;
      }
    });
  }
  
  // ë³´í—˜ íƒ€ì… í•„í„°
  const insuranceFilter = document.getElementById('insuranceFilter').value;
  if (insuranceFilter) {
    filtered = filtered.filter(p => p.insurance_type === insuranceFilter);
  }
  
  // ê²€ì§„ ìƒíƒœ í•„í„°
  const checkupFilter = document.getElementById('checkupFilter').value;
  if (checkupFilter === 'needs') {
    filtered = filtered.filter(p => needsCheckup(p));
  } else if (checkupFilter === 'recent') {
    filtered = filtered.filter(p => !needsCheckup(p));
  }
  
  filteredPatientList = filtered;
}

// ì—°ë ¹ ê³„ì‚° í•¨ìˆ˜
function calculateAge(birthDate) {
  const today = new Date();
  const birth = new Date(birthDate);
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--;
  }
  
  return age;
}

// ê²€ì§„ í•„ìš” ì—¬ë¶€ í™•ì¸
function needsCheckup(patient) {
  if (!patient.last_checkup_date) return true;
  
  const lastCheckup = new Date(patient.last_checkup_date);
  const today = new Date();
  const monthsDiff = (today.getFullYear() - lastCheckup.getFullYear()) * 12 + 
                    (today.getMonth() - lastCheckup.getMonth());
  
  const cycleMonths = (patient.checkup_cycle || 1) * 12;
  return monthsDiff >= cycleMonths;
}

// í™˜ì ëª©ë¡ í‘œì‹œ ì—…ë°ì´íŠ¸
function updatePatientDisplay() {
  const tableBody = document.getElementById('patients-table-body');
  const countElement = document.getElementById('total-count');
  
  if (!tableBody) return;
  
  if (filteredPatientList.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="9" class="px-6 py-12 text-center">
          <div class="text-6xl mb-4">ğŸ”</div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">í™˜ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
          <p class="text-gray-500">ê²€ìƒ‰ ì¡°ê±´ì„ ë³€ê²½í•˜ê±°ë‚˜ ìƒˆ í™˜ìë¥¼ ë“±ë¡í•´ë³´ì„¸ìš”.</p>
        </td>
      </tr>
    `;
  } else {
    tableBody.innerHTML = filteredPatientList.slice(0, 20).map(patient => renderPatientTableRow(patient)).join('');
  }
  
  if (countElement) {
    countElement.textContent = filteredPatientList.length;
  }
  
  updateStatistics();
}

// í†µê³„ ì—…ë°ì´íŠ¸
function updateStatistics() {
  const totalCount = currentPatientList.length;
  const activeCount = currentPatientList.filter(p => {
    const lastVisit = new Date(p.last_checkup_date);
    const sixMonthsAgo = new Date();
    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
    return lastVisit >= sixMonthsAgo;
  }).length;
  
  const thisMonth = new Date();
  thisMonth.setDate(1);
  const newCount = currentPatientList.filter(p => new Date(p.created_at) >= thisMonth).length;
  
  const needsCount = currentPatientList.filter(p => needsCheckup(p)).length;
  
  const totalPatientsElement = document.getElementById('total-patients-count');
  const activePatientsElement = document.getElementById('active-patients-count');
  const newPatientsElement = document.getElementById('new-patients-count');
  const needsCheckupElement = document.getElementById('needs-checkup-count');
  
  if (totalPatientsElement) totalPatientsElement.textContent = totalCount;
  if (activePatientsElement) activePatientsElement.textContent = activeCount;
  if (newPatientsElement) newPatientsElement.textContent = newCount;
  if (needsCheckupElement) needsCheckupElement.textContent = needsCount;
  
  const ages = currentPatientList.map(p => calculateAge(p.birth_date));
  const avgAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b) / ages.length) : 0;
  
  const averageAgeElement = document.getElementById('average-age');
  if (averageAgeElement) {
    averageAgeElement.textContent = `${avgAge}ì„¸`;
  }
}

// í™˜ì í…Œì´ë¸” í–‰ ë Œë”ë§
function renderPatientTableRow(patient) {
  const age = calculateAge(patient.birth_date);
  const genderText = patient.gender === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±';
  const needsCheckupStatus = needsCheckup(patient);
  
  const statusBadge = needsCheckupStatus ? 
    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">ê²€ì§„ í•„ìš”</span>' :
    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">ì •ìƒ</span>';
  
  return `
    <tr class="hover:bg-gray-50 cursor-pointer select-none" 
        ondblclick="openPatientDetailModal('${patient.id}')"
        title="ë”ë¸” í´ë¦­í•˜ì—¬ í™˜ì ìƒì„¸ ì •ë³´ ë³´ê¸°">
      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
        ${patient.name}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
        ${patient.patient_number}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
        ${age}ì„¸
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
        ${genderText}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
        ${patient.phone}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
        ${patient.insurance_type || '-'}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
        ${patient.last_checkup_date ? formatDate(patient.last_checkup_date) : '-'}
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        ${statusBadge}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" onclick="event.stopPropagation();">
        <div class="flex space-x-2">
          <button onclick="editPatient('${patient.id}')" 
                  class="text-blue-600 hover:text-blue-800 font-medium">ìˆ˜ì •</button>
          <button onclick="createAppointmentForPatient('${patient.id}')" 
                  class="text-green-600 hover:text-green-800 font-medium">ì˜ˆì•½</button>
        </div>
      </td>
    </tr>
  `;
}

// í™˜ì ì¹´ë“œ ë Œë”ë§ (ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€ - í•„ìš”ì‹œ ì‚¬ìš©)
function renderPatientCard(patient) {
  const age = calculateAge(patient.birth_date);
  const genderIcon = patient.gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©';
  const needsCheckupStatus = needsCheckup(patient);
  
  return `
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all duration-200 cursor-pointer transform hover:-translate-y-1"
         onclick="showPatientDetail('${patient.id}')">
      <div class="flex items-start justify-between mb-4">
        <div class="flex items-center">
          <div class="text-2xl mr-3">${genderIcon}</div>
          <div>
            <h3 class="text-lg font-semibold text-gray-900">${patient.name}</h3>
            <p class="text-sm text-gray-500">${patient.patient_number} â€¢ ${age}ì„¸</p>
          </div>
        </div>
        <div class="flex flex-col items-end space-y-2">
          ${needsCheckupStatus ? 
            '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">ê²€ì§„ í•„ìš”</span>' :
            '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">ì •ìƒ</span>'
          }
        </div>
      </div>
      
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-500">ì—°ë½ì²˜:</span>
          <span class="font-medium">${patient.phone}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500">í˜ˆì•¡í˜•:</span>
          <span class="font-medium">${patient.blood_type || '-'}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500">ìµœê·¼ ê²€ì§„:</span>
          <span class="font-medium">${patient.last_checkup_date ? formatDate(patient.last_checkup_date) : 'ì—†ìŒ'}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500">ë³´í—˜:</span>
          <span class="font-medium">${patient.insurance_type || '-'}</span>
        </div>
      </div>
      
      <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between">
        <button onclick="event.stopPropagation(); editPatient('${patient.id}')" 
                class="text-blue-600 hover:text-blue-800 text-sm font-medium">ìˆ˜ì •</button>
        <button onclick="event.stopPropagation(); createAppointmentForPatient('${patient.id}')" 
                class="text-green-600 hover:text-green-800 text-sm font-medium">ì˜ˆì•½</button>
      </div>
    </div>
  `;
}

// ë‚ ì§œ í¬ë§· í•¨ìˆ˜
function formatDate(dateString) {
  if (!dateString) return '-';
  const date = new Date(dateString);
  return date.toLocaleDateString('ko-KR', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  });
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
function initializeEventListeners() {
  // ê²€ìƒ‰ ì…ë ¥
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    let searchTimeout;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(handleSearch, 300);
    });
  }
  
  // í•„í„° ë³€ê²½
  const filters = ['genderFilter', 'ageFilter', 'insuranceFilter', 'checkupFilter'];
  filters.forEach(filterId => {
    const element = document.getElementById(filterId);
    if (element) {
      element.addEventListener('change', () => {
        applyAllFilters();
        updatePatientDisplay();
      });
    }
  });
  
  // í•„í„° ì´ˆê¸°í™” ë²„íŠ¼
  const resetButton = document.getElementById('resetFilters');
  if (resetButton) {
    resetButton.addEventListener('click', () => {
      // ëª¨ë“  í•„í„° ì´ˆê¸°í™”
      document.getElementById('searchInput').value = '';
      document.getElementById('genderFilter').value = '';
      document.getElementById('ageFilter').value = '';
      document.getElementById('insuranceFilter').value = '';
      document.getElementById('checkupFilter').value = '';
      
      currentSearchTerm = '';
      filteredPatientList = [...currentPatientList];
      updatePatientDisplay();
    });
  }
}

// í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
  initializeEventListeners();
  
  // Mock ë°ì´í„°ë¡œ ì´ˆê¸° í™˜ì ëª©ë¡ ì„¤ì • (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” APIì—ì„œ ê°€ì ¸ì˜´)
  currentPatientList = generateMockPatients();
  filteredPatientList = [...currentPatientList];
  updatePatientDisplay();
});

// Mock ë°ì´í„° ìƒì„± í•¨ìˆ˜
function generateMockPatients() {
  // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” APIì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤
  return [
    {
      id: '1',
      patient_number: 'P24110001',
      name: 'ê¹€ë¯¼ìˆ˜',
      gender: 'male',
      birth_date: '1985-03-15',
      phone: '010-1234-5678',
      email: 'kim@example.com',
      address: 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123',
      blood_type: 'A+',
      insurance_type: 'êµ­ë¯¼ê±´ê°•ë³´í—˜',
      occupation: 'íšŒì‚¬ì›',
      height: 175,
      weight: 70,
      smoking_status: 'never',
      drinking_frequency: 'social',
      exercise_frequency: 'regular',
      last_checkup_date: '2023-12-15',
      checkup_cycle: 1,
      created_at: '2024-01-15',
      checkup_history: [
        {
          id: '1',
          date: '2023-12-15',
          type: 'ì¢…í•©ê²€ì§„',
          doctor: 'ê¹€ì˜ì‚¬',
          status: 'completed',
          result: 'ì •ìƒ'
        }
      ],
      medical_history: [],
      family_history: []
    },
    {
      id: '2',
      patient_number: 'P24110002',
      name: 'ì´ì˜í¬',
      gender: 'female',
      birth_date: '1992-07-22',
      phone: '010-2345-6789',
      email: 'lee@example.com',
      address: 'ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ê°•ë‚¨ëŒ€ë¡œ 456',
      blood_type: 'B+',
      insurance_type: 'ì§ì¥ê°€ì…ì',
      occupation: 'ê°„í˜¸ì‚¬',
      height: 162,
      weight: 55,
      smoking_status: 'never',
      drinking_frequency: 'none',
      exercise_frequency: 'light',
      last_checkup_date: '2024-01-20',
      checkup_cycle: 2,
      created_at: '2024-02-01',
      checkup_history: [
        {
          id: '2',
          date: '2024-01-20',
          type: 'ê¸°ë³¸ê²€ì§„',
          doctor: 'ë°•ì˜ì‚¬',
          status: 'completed',
          result: 'ì •ìƒ'
        }
      ],
      medical_history: [
        {
          condition: 'ì•Œë ˆë¥´ê¸°ì„± ë¹„ì—¼',
          diagnosis_date: '2020-05-15',
          status: 'active',
          notes: 'ë´„ì²  ê½ƒê°€ë£¨ ì•Œë ˆë¥´ê¸°'
        }
      ],
      family_history: [
        {
          relation: 'ëª¨',
          condition: 'ê³ í˜ˆì••',
          notes: '60ì„¸ ì§„ë‹¨'
        }
      ]
    },
    {
      id: '3',
      patient_number: 'P24110003',
      name: 'ë°•ì² ìˆ˜',
      gender: 'male',
      birth_date: '1978-11-08',
      phone: '010-3456-7890',
      email: 'park@example.com',
      address: 'ì„œìš¸ì‹œ ë§ˆí¬êµ¬ ì›”ë“œì»µë¡œ 789',
      blood_type: 'O+',
      insurance_type: 'êµ­ë¯¼ê±´ê°•ë³´í—˜',
      occupation: 'êµì‚¬',
      height: 180,
      weight: 80,
      smoking_status: 'former',
      drinking_frequency: 'social',
      exercise_frequency: 'intensive',
      last_checkup_date: '2023-08-10',
      checkup_cycle: 1,
      created_at: '2023-08-10',
      checkup_history: [
        {
          id: '3',
          date: '2023-08-10',
          type: 'ì¢…í•©ê²€ì§„',
          doctor: 'ì´ì˜ì‚¬',
          status: 'completed',
          result: 'ì£¼ì˜'
        }
      ],
      medical_history: [],
      family_history: []
    }
    // ì¶”ê°€ Mock ë°ì´í„°ëŠ” ì‹¤ì œ êµ¬í˜„ì‹œ í™•ì¥
  ];
}
</script>