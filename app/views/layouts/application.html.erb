<!DOCTYPE html>
<html>
  <head>
    <title>ë³‘ì› í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Asset pipeline í™œì„±í™” -->
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload", "data-turbo-eval": "false" %>
    
    <style>
      /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
      #sidebar {
        width: 16rem; /* 256px */
        transition: width 0.3s ease-in-out;
      }
      
      #sidebar[data-collapsed="true"] {
        width: 4rem; /* 64px */
      }
      
      #sidebar[data-collapsed="true"] .sidebar-text {
        display: none;
      }
      
      #sidebar[data-collapsed="true"] .sidebar-icon {
        margin-right: 0;
        display: block;
        text-align: center;
        width: 100%;
      }
      
      #sidebar[data-collapsed="true"] nav a {
        justify-content: center;
      }
      
      #sidebar[data-collapsed="true"] .border-t {
        margin: 0.5rem 0;
      }
      
      /* í† ê¸€ ë²„íŠ¼ íšŒì „ */
      #sidebar[data-collapsed="true"] #sidebar-toggle-btn svg {
        transform: rotate(180deg);
      }
      
      /* ì‚¬ìš©ì ì •ë³´ ì˜ì—­ ìŠ¤íƒ€ì¼ */
      #sidebar .flex-shrink-0:last-child {
        width: 100%;
        box-sizing: border-box;
      }
      
      #sidebar[data-collapsed="true"] .sidebar-text {
        display: none;
      }
      
      #sidebar[data-collapsed="true"] .sidebar-icon-only {
        display: flex !important;
      }
      
      #sidebar .sidebar-icon-only {
        display: none;
      }
      
      /* ì‚¬ìš©ì ì˜ì—­ footer ìŠ¤íƒ€ì¼ */
      #sidebar .flex-shrink-0:last-child {
        background-color: #f9fafb; /* gray-50 */
        border-top: 2px solid #d1d5db; /* gray-300 */
      }
      
      #sidebar[data-collapsed="true"] .flex-shrink-0:last-child {
        background-color: #f3f4f6; /* gray-100 ì¶•ì†Œ ì‹œ ì¡°ê¸ˆ ë” ì–´ë‘¡ê²Œ */
      }
      
      /* ì¶•ì†Œ ëª¨ë“œì—ì„œ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
      #sidebar[data-collapsed="true"] .sidebar-icon-only.logout-mode {
        background-color: #ef4444; /* red-500 */
        border-radius: 50%;
      }
      
      #sidebar[data-collapsed="true"] .sidebar-icon-only.logout-mode:hover {
        background-color: #dc2626; /* red-600 */
      }
      
      /* ëª¨ë°”ì¼ì—ì„œëŠ” í•­ìƒ ì „ì²´ ë„ˆë¹„ */
      @media (max-width: 1024px) {
        #sidebar {
          width: 16rem !important;
          transform: translateX(-100%);
        }
        
        #sidebar.sidebar-open {
          transform: translateX(0);
        }
        
        #sidebar[data-collapsed="true"] .sidebar-text {
          display: block;
        }
        
        #sidebar[data-collapsed="true"] .sidebar-icon {
          margin-right: 0.75rem;
        }
        
        #sidebar[data-collapsed="true"] .sidebar-icon-only {
          display: none !important;
        }
      }

      /* AI ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
      #ai-sidebar {
        width: 20rem; /* 320px */
        transition: width 0.3s ease-in-out, transform 0.3s ease-in-out;
      }
      
      #ai-sidebar[data-hidden="true"] {
        transform: translateX(100%);
      }
      
      /* ëª¨ë°”ì¼ì—ì„œ AI ì‚¬ì´ë“œë°” */
      @media (max-width: 1024px) {
        #ai-sidebar {
          width: 20rem !important;
          transform: translateX(100%);
        }
        
        #ai-sidebar.ai-sidebar-open {
          transform: translateX(0);
        }
      }
    </style>
  </head>

  <body class="bg-gray-50">
    <div class="min-h-screen flex">
      <!-- ì‚¬ì´ë“œë°” -->
      <div class="fixed inset-y-0 left-0 z-50 bg-white shadow-lg transition-all duration-300 ease-in-out lg:fixed lg:inset-y-0 flex flex-col" id="sidebar" data-collapsed="false">
        <div class="flex items-center justify-between h-16 px-4 border-b border-gray-200 flex-shrink-0">
          <h1 class="text-lg font-bold text-gray-900 sidebar-text">ğŸ¥ ë³‘ì› ì¸íŠ¸ë¼ë„·</h1>
          <button onclick="toggleSidebar()" class="hidden lg:block p-1 rounded hover:bg-gray-100 transition-transform duration-300" id="sidebar-toggle-btn">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </button>
        </div>
        
        <nav class="mt-5 px-2 flex-1 overflow-y-auto">
          <div class="space-y-1">
            <!-- í™ˆ -->
            <a href="/dashboard" class="bg-blue-100 text-blue-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md" title="ëŒ€ì‹œë³´ë“œ">
              <span class="sidebar-icon mr-3">ğŸ </span>
              <span class="sidebar-text">ëŒ€ì‹œë³´ë“œ</span>
            </a>
            
            <!-- ì¸íŠ¸ë¼ë„· í•µì‹¬ ê¸°ëŠ¥ë“¤ -->
            <a href="/announcements" class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md" title="ê³µì§€ì‚¬í•­">
              <span class="sidebar-icon mr-3">ğŸ“¢</span>
              <span class="sidebar-text">ê³µì§€ì‚¬í•­</span>
            </a>
            
            <a href="/boards" class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md" title="ë¶€ì„œë³„ ê²Œì‹œíŒ">
              <span class="sidebar-icon mr-3">ğŸ“‹</span>
              <span class="sidebar-text">ë¶€ì„œë³„ ê²Œì‹œíŒ</span>
            </a>
            
            <a href="/documents" class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md" title="ë¬¸ì„œ/ì „ìê²°ì¬">
              <span class="sidebar-icon mr-3">ğŸ“„</span>
              <span class="sidebar-text">ë¬¸ì„œ/ì „ìê²°ì¬</span>
            </a>
            
            <a href="/hr" class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md" title="ì¸ì‚¬/ê¸‰ì—¬">
              <span class="sidebar-icon mr-3">ğŸ‘¨â€âš•ï¸</span>
              <span class="sidebar-text">ì¸ì‚¬/ê¸‰ì—¬</span>
            </a>
            
            <a href="/appointments" class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md" title="ì˜ˆì•½/ì ‘ìˆ˜">
              <span class="sidebar-icon mr-3">ğŸ“…</span>
              <span class="sidebar-text">ì˜ˆì•½/ì ‘ìˆ˜</span>
            </a>
            
            <a href="/patients" class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md" title="í™˜ìê´€ë¦¬">
              <span class="sidebar-icon mr-3">ğŸ‘¥</span>
              <span class="sidebar-text">í™˜ìê´€ë¦¬</span>
            </a>
            
            <a href="/finance" class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md" title="ì˜ˆì‚°/ì¬ë¬´">
              <span class="sidebar-icon mr-3">ğŸ’°</span>
              <span class="sidebar-text">ì˜ˆì‚°/ì¬ë¬´</span>
            </a>
            
            <a href="/facilities" class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md" title="ì‹œì„¤/ìì‚°">
              <span class="sidebar-icon mr-3">ğŸ¢</span>
              <span class="sidebar-text">ì‹œì„¤/ìì‚°</span>
            </a>
            
            <!-- êµ¬ë¶„ì„  -->
            <div class="border-t border-gray-200 my-4"></div>
            
            <!-- í–¥í›„ ê°œë°œ ì˜ˆì • (íšŒìƒ‰ ì²˜ë¦¬) -->
            <div class="text-xs font-medium text-gray-400 uppercase tracking-wider px-2 py-2 sidebar-text">í–¥í›„ ê°œë°œ ì˜ˆì •</div>
            
            <a href="#" class="text-gray-400 group flex items-center px-2 py-2 text-sm font-medium rounded-md cursor-not-allowed" title="ìƒë‹´/CRM">
              <span class="sidebar-icon mr-3">ğŸ’¬</span>
              <span class="sidebar-text">ìƒë‹´/CRM</span>
            </a>
            
            <a href="#" class="text-gray-400 group flex items-center px-2 py-2 text-sm font-medium rounded-md cursor-not-allowed" title="ì§„ë£Œ/ê²€ì§„">
              <span class="sidebar-icon mr-3">ğŸ©º</span>
              <span class="sidebar-text">ì§„ë£Œ/ê²€ì§„</span>
            </a>
            
            <a href="#" class="text-gray-400 group flex items-center px-2 py-2 text-sm font-medium rounded-md cursor-not-allowed" title="ì¬ê³ /êµ¬ë§¤">
              <span class="sidebar-icon mr-3">ğŸ“¦</span>
              <span class="sidebar-text">ì¬ê³ /êµ¬ë§¤</span>
            </a>
            
            <a href="#" class="text-gray-400 group flex items-center px-2 py-2 text-sm font-medium rounded-md cursor-not-allowed" title="í†µê³„">
              <span class="sidebar-icon mr-3">ğŸ“Š</span>
              <span class="sidebar-text">í†µê³„</span>
            </a>
          </div>
        </nav>
        
        <!-- ì‚¬ìš©ì ì •ë³´ ì˜ì—­ (Footer) -->
        <div class="flex-shrink-0 mt-auto border-t-2 border-gray-300 bg-gray-50">
          <div class="px-2 py-3">
            <!-- ì‚¬ìš©ì í™˜ì˜ ë©”ì‹œì§€ -->
            <div class="sidebar-text group flex items-center px-2 py-2 text-sm rounded-md mb-1">
              <span class="sidebar-icon mr-3">ğŸ‘¤</span>
              <div class="flex-1 min-w-0">
                <span id="user-welcome" class="text-gray-700 block truncate font-medium">í™˜ì˜í•©ë‹ˆë‹¤!</span>
              </div>
            </div>
            
            <!-- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
            <div id="auth-buttons" class="sidebar-text mb-2">
              <%= link_to login_path, class: "text-gray-700 hover:bg-white hover:text-blue-600 hover:shadow-sm group flex items-center px-2 py-2 text-sm font-medium rounded-md transition-all duration-200" do %>
                <span class="sidebar-icon mr-3">ğŸ”‘</span>
                <span class="sidebar-text">ë¡œê·¸ì¸</span>
              <% end %>
            </div>
            
            <!-- ë²„ì „ ì •ë³´ -->
            <div class="sidebar-text border-t border-gray-200 pt-2">
              <div class="px-2 py-1 text-center">
                <span class="text-xs text-gray-500 font-mono">Hospital System v.2.38.1</span>
              </div>
            </div>
          </div>
          
          <!-- ì¶•ì†Œ ëª¨ë“œ ì•„ì´ì½˜ -->
          <div class="sidebar-icon-only hidden justify-center items-center py-4" id="collapsed-user-icon">
            <a href="#" class="text-gray-600 hover:text-gray-800 hover:bg-white rounded-full p-2 transition-all duration-200" title="ì‚¬ìš©ì ë©”ë‰´">
              <span class="text-xl">ğŸ‘¤</span>
            </a>
          </div>
        </div>
      </div>

      <!-- ëª¨ë°”ì¼ ì˜¤ë²„ë ˆì´ -->
      <div class="fixed inset-0 z-40 bg-gray-600 bg-opacity-75 transition-opacity duration-300 ease-linear lg:hidden hidden" id="sidebar-overlay"></div>

      <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
      <div class="flex-1 flex flex-col lg:ml-64" id="main-content">
        <!-- ìƒë‹¨ ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="sticky top-0 z-10 bg-white pl-1 pt-1 sm:pl-3 sm:pt-3 lg:hidden">
          <button type="button" class="-ml-0.5 -mt-0.5 h-12 w-12 inline-flex items-center justify-center rounded-md text-gray-500 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500" id="sidebar-toggle">
            <span class="sr-only">ì‚¬ì´ë“œë°” ì—´ê¸°</span>
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="flex-1 relative z-0 overflow-y-auto focus:outline-none">
          <div class="py-6">
            <%= yield %>
          </div>
        </main>
      </div>

      <!-- AI ì‚¬ì´ë“œë°” -->
      <div class="fixed inset-y-0 right-0 z-50 bg-white shadow-lg transition-all duration-300 ease-in-out lg:fixed lg:inset-y-0 flex flex-col border-l border-gray-200" id="ai-sidebar" data-hidden="true">
        <!-- AI ì‚¬ì´ë“œë°” í—¤ë” -->
        <div class="h-16 px-4 border-b border-gray-200 flex-shrink-0 transition-all duration-500" id="ai-sidebar-header">
          <!-- í˜ë¥´ì†Œë‚˜ ì„ íƒ ì˜ì—­ -->
          <div class="flex items-center justify-between h-full">
            <div class="flex items-center space-x-3 flex-1">
              <!-- í˜ë¥´ì†Œë‚˜ ì•„ë°”íƒ€ -->
              <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl transition-all duration-300" id="persona-avatar">
                ğŸ¤–
              </div>
              
              <!-- í˜ë¥´ì†Œë‚˜ ì •ë³´ -->
              <div class="flex-1 min-w-0">
                <div class="relative">
                  <select 
                    id="persona-selector" 
                    class="appearance-none bg-transparent text-white font-bold text-sm cursor-pointer focus:outline-none pr-6 w-full"
                    onchange="changePersona(this.value)"
                  >
                    <option value="default" data-icon="ğŸ¤–" data-color="from-purple-600 to-blue-600">AI ì–´ì‹œìŠ¤í„´íŠ¸</option>
                    <option value="doctor" data-icon="ğŸ©º" data-color="from-green-600 to-emerald-600">ë‹¥í„° ê¹€</option>
                    <option value="nurse" data-icon="ğŸ‘©â€âš•ï¸" data-color="from-pink-500 to-rose-500">ê°„í˜¸ì‚¬ ì´</option>
                    <option value="manager" data-icon="ğŸ’¼" data-color="from-indigo-600 to-blue-600">ë§¤ë‹ˆì € ë°•</option>
                    <option value="tech" data-icon="ğŸ”§" data-color="from-gray-600 to-slate-600">í…Œí‚¤</option>
                  </select>
                  <div class="absolute inset-y-0 right-0 flex items-center pointer-events-none">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </div>
                </div>
                <div class="flex items-center space-x-1">
                  <p class="text-xs text-white text-opacity-80 truncate" id="persona-title">ì¼ë°˜ AI ì–´ì‹œìŠ¤í„´íŠ¸</p>
                  <div class="relative">
                    <div class="w-3 h-3 bg-white bg-opacity-20 rounded-full flex items-center justify-center cursor-help hover:bg-opacity-30 transition-all duration-200" id="persona-info-icon">
                      <span class="text-xs text-white font-bold">?</span>
                    </div>
                    <!-- íˆ´íŒ -->
                    <div class="absolute top-full right-0 mt-2 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-lg opacity-0 invisible transition-all duration-200 z-50" id="persona-tooltip">
                      <div class="absolute bottom-full right-4 border-4 border-transparent border-b-gray-900"></div>
                      <div id="persona-tooltip-content">
                        <!-- íˆ´íŒ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- í—¤ë” ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
            <div class="flex items-center space-x-2 ml-2">
              <!-- ìƒˆ ëŒ€í™” ë²„íŠ¼ -->
              <button 
                onclick="startNewConversation()" 
                class="p-1 rounded hover:bg-white hover:bg-opacity-20 transition-all duration-200 group relative"
                title="ìƒˆ ëŒ€í™” ì‹œì‘ (Ctrl+Shift+N)"
              >
                <svg class="w-4 h-4 text-white group-hover:text-opacity-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                <!-- ì‘ì€ ìƒˆë¡œê³ ì¹¨ ì•„ì´ì½˜ì„ ì˜¤ë²„ë ˆì´ -->
                <div class="absolute -bottom-0.5 -right-0.5 w-2 h-2 bg-white rounded-full flex items-center justify-center">
                  <svg class="w-1.5 h-1.5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                  </svg>
                </div>
              </button>
              
              <!-- ë‹«ê¸° ë²„íŠ¼ -->
              <button onclick="toggleAISidebar()" class="p-1 rounded hover:bg-white hover:bg-opacity-20 transition-all duration-200" id="ai-sidebar-close-btn">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>
        </div>
        
        <!-- ì±„íŒ… ì˜ì—­ -->
        <div class="flex-1 flex flex-col">
          <!-- ë©”ì‹œì§€ ëª©ë¡ -->
          <div class="flex-1 overflow-y-auto p-4 relative" id="ai-chat-messages">
            <div class="space-y-4">
              <!-- í™˜ì˜ ë©”ì‹œì§€ -->
              <div class="flex items-start space-x-2">
                <div class="w-8 h-8 persona-default rounded-full flex items-center justify-center flex-shrink-0">
                  <span class="text-white text-sm">ğŸ¤–</span>
                </div>
                <div class="flex-1">
                  <div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
                    <p class="text-sm text-gray-800">ì•ˆë…•í•˜ì„¸ìš”! HSC1 ë³‘ì› ê´€ë¦¬ ì‹œìŠ¤í…œì˜ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</p>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">ë°©ê¸ˆ ì „</div>
                </div>
              </div>
            </div>
            
            <!-- ìŠ¤í¬ë¡¤ ì¸ë””ì¼€ì´í„° -->
            <div class="scroll-indicator" id="scroll-indicator">ìƒˆ ë©”ì‹œì§€ â†“</div>
          </div>
          
          <!-- ì…ë ¥ ì˜ì—­ -->
          <div class="border-t border-gray-200 p-4 bg-gray-50">
            <div class="flex space-x-2">
              <input 
                type="text" 
                placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                id="ai-chat-input"
                onkeypress="handleChatInput(event)"
              >
              <button 
                onclick="sendChatMessage()" 
                class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all duration-200 flex items-center justify-center"
                id="ai-chat-send-btn"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
              </button>
            </div>
            
            <!-- ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
            <div class="mt-3 flex flex-wrap gap-2 items-center justify-between">
              <div class="flex flex-wrap gap-2" id="quick-actions">
                <button onclick="sendQuickMessage('í™˜ì ì •ë³´ ê²€ìƒ‰')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs hover:bg-blue-200 transition-colors">
                  í™˜ì ì •ë³´ ê²€ìƒ‰
                </button>
                <button onclick="sendQuickMessage('ì˜¤ëŠ˜ ì¼ì • í™•ì¸')" class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs hover:bg-green-200 transition-colors">
                  ì˜¤ëŠ˜ ì¼ì • í™•ì¸
                </button>
                <button onclick="sendQuickMessage('í†µê³„ ìš”ì•½')" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs hover:bg-purple-200 transition-colors">
                  í†µê³„ ìš”ì•½
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- AI ì‚¬ì´ë“œë°” í† ê¸€ ë²„íŠ¼ (ìš°í•˜ë‹¨ ê³ ì •) -->
      <button 
        onclick="toggleAISidebar()" 
        class="fixed bottom-6 right-6 z-40 w-14 h-14 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center"
        id="ai-sidebar-toggle-btn"
        title="AI ì–´ì‹œìŠ¤í„´íŠ¸"
      >
        <span class="text-xl">ğŸ¤–</span>
      </button>
    </div>

    <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
    <div id="toast-container" class="toast-container"></div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loading-overlay" class="loading-overlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">ì²˜ë¦¬ ì¤‘...</div>
      </div>
    </div>

    <script>
      // í† ìŠ¤íŠ¸ ì•Œë¦¼ ì‹œìŠ¤í…œ
      class ToastManager {
        constructor() {
          this.container = document.getElementById('toast-container');
          this.toasts = [];
        }

        show(message, type = 'info', title = null, duration = 5000) {
          const toast = this.createToast(message, type, title, duration);
          this.container.appendChild(toast);
          
          // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ ì§€ì—°
          setTimeout(() => {
            toast.classList.add('show');
          }, 10);

          // ìë™ ì œê±°
          setTimeout(() => {
            this.removeToast(toast);
          }, duration);

          return toast;
        }

        createToast(message, type, title, duration) {
          const toast = document.createElement('div');
          toast.className = `toast toast-${type}`;
          
          const icons = {
            success: 'âœ“',
            error: 'âœ•',
            warning: 'âš ',
            info: 'â„¹'
          };

          const icon = icons[type] || icons.info;
          
          toast.innerHTML = `
            <div class="toast-icon">${icon}</div>
            <div class="toast-content">
              ${title ? `<div class="toast-title">${title}</div>` : ''}
              <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="window.toast.removeToast(this.parentElement)">&times;</button>
          `;

          return toast;
        }

        removeToast(toast) {
          toast.classList.add('hide');
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }

        // í¸ì˜ ë©”ì„œë“œë“¤
        success(message, title = null) {
          return this.show(message, 'success', title);
        }

        error(message, title = null) {
          return this.show(message, 'error', title || 'ì˜¤ë¥˜');
        }

        warning(message, title = null) {
          return this.show(message, 'warning', title || 'ê²½ê³ ');
        }

        info(message, title = null) {
          return this.show(message, 'info', title || 'ì•Œë¦¼');
        }
      }

      // ì „ì—­ í† ìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
      window.toast = new ToastManager();

      // ë¡œë”© ê´€ë¦¬ì
      class LoadingManager {
        constructor() {
          this.overlay = document.getElementById('loading-overlay');
          this.textElement = document.getElementById('loading-text');
          this.isShowing = false;
        }

        show(message = 'ì²˜ë¦¬ ì¤‘...') {
          this.textElement.textContent = message;
          this.overlay.classList.add('show');
          this.isShowing = true;
        }

        hide() {
          this.overlay.classList.remove('show');
          this.isShowing = false;
        }

        // ë²„íŠ¼ ë¡œë”© ìƒíƒœ ê´€ë¦¬
        setButtonLoading(button, loading = true) {
          if (loading) {
            button.classList.add('btn-loading');
            button.disabled = true;
          } else {
            button.classList.remove('btn-loading');
            button.disabled = false;
          }
        }

        // ë°ì´í„° ì˜ì—­ ë¡œë”© ìƒíƒœ ê´€ë¦¬
        showDataLoading(container, message = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...') {
          container.innerHTML = `
            <div class="data-loading">
              <div class="data-loading-spinner"></div>
              <div class="data-loading-text">${message}</div>
            </div>
          `;
        }
      }

      // ì „ì—­ ë¡œë”© ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
      window.loading = new LoadingManager();

      // í¼ ê²€ì¦ ê´€ë¦¬ì
      class FormValidator {
        constructor() {
          this.rules = {};
          this.debounceTimers = {};
        }

        // ê²€ì¦ ê·œì¹™ ì¶”ê°€
        addRule(fieldName, rule) {
          if (!this.rules[fieldName]) {
            this.rules[fieldName] = [];
          }
          this.rules[fieldName].push(rule);
        }

        // í•„ë“œ ê²€ì¦
        validateField(field) {
          const fieldName = field.name;
          const value = field.value.trim();
          const fieldContainer = field.closest('.form-field') || field.parentElement;
          
          if (!this.rules[fieldName]) return true;

          // ê²€ì¦ ì¤‘ ìƒíƒœ í‘œì‹œ
          this.setFieldState(fieldContainer, 'validating');

          let isValid = true;
          let errorMessage = '';

          for (const rule of this.rules[fieldName]) {
            const result = rule.validate(value);
            if (!result.valid) {
              isValid = false;
              errorMessage = result.message;
              break;
            }
          }

          // ê²°ê³¼ í‘œì‹œ
          setTimeout(() => {
            if (isValid) {
              this.setFieldState(fieldContainer, 'valid');
            } else {
              this.setFieldState(fieldContainer, 'invalid', errorMessage);
            }
          }, 300); // ê²€ì¦ ì¤‘ íš¨ê³¼ë¥¼ ìœ„í•œ ì§€ì—°

          return isValid;
        }

        // í•„ë“œ ìƒíƒœ ì„¤ì •
        setFieldState(container, state, message = '') {
          container.classList.remove('valid', 'invalid', 'validating');
          
          if (state !== 'neutral') {
            container.classList.add(state);
          }

          const errorElement = container.querySelector('.field-error');
          const successElement = container.querySelector('.field-success');

          if (errorElement) errorElement.textContent = message;
          if (successElement && state === 'valid') {
            successElement.textContent = 'ì…ë ¥ì´ ì˜¬ë°”ë¦…ë‹ˆë‹¤';
          }
        }

        // ì‹¤ì‹œê°„ ê²€ì¦ ì´ë²¤íŠ¸ ì—°ê²°
        bindField(field, debounceMs = 500) {
          const fieldName = field.name;
          
          // ì…ë ¥ ì´ë²¤íŠ¸
          field.addEventListener('input', (e) => {
            clearTimeout(this.debounceTimers[fieldName]);
            this.debounceTimers[fieldName] = setTimeout(() => {
              this.validateField(e.target);
            }, debounceMs);
          });

          // í¬ì»¤ìŠ¤ í•´ì œ ì´ë²¤íŠ¸
          field.addEventListener('blur', (e) => {
            clearTimeout(this.debounceTimers[fieldName]);
            this.validateField(e.target);
          });
        }

        // ì „ì²´ í¼ ê²€ì¦
        validateForm(form) {
          const fields = form.querySelectorAll('[name]');
          let isValid = true;

          fields.forEach(field => {
            if (!this.validateField(field)) {
              isValid = false;
            }
          });

          return isValid;
        }

        // ê³µí†µ ê²€ì¦ ê·œì¹™ë“¤
        static rules = {
          required: (message = 'í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤') => ({
            validate: (value) => ({
              valid: value.length > 0,
              message: message
            })
          }),

          minLength: (min, message = null) => ({
            validate: (value) => ({
              valid: value.length >= min,
              message: message || `ìµœì†Œ ${min}ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”`
            })
          }),

          maxLength: (max, message = null) => ({
            validate: (value) => ({
              valid: value.length <= max,
              message: message || `ìµœëŒ€ ${max}ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤`
            })
          }),

          email: (message = 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”') => ({
            validate: (value) => {
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              return {
                valid: value === '' || emailRegex.test(value),
                message: message
              };
            }
          }),

          phone: (message = 'ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”') => ({
            validate: (value) => {
              const phoneRegex = /^[0-9\-\s()]+$/;
              return {
                valid: value === '' || phoneRegex.test(value),
                message: message
              };
            }
          }),

          korean: (message = 'í•œê¸€, ì˜ë¬¸, ê³µë°±ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤') => ({
            validate: (value) => {
              const koreanRegex = /^[ê°€-í£a-zA-Z\s]*$/;
              return {
                valid: koreanRegex.test(value),
                message: message
              };
            }
          })
        }
      }

      // ì „ì—­ í¼ ê²€ì¦ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
      window.validator = new FormValidator();
      
    </script>
    
    <!-- í™˜ê²½ ë³€ìˆ˜ ì„¤ì • -->
    <script>
      window.BACKEND_API_URL = '<%= ENV.fetch("BACKEND_API_URL", "http://localhost:7001/api/v1") %>';
    </script>

    <!-- API ë° UI ëª¨ë“ˆ ì¸ë¼ì¸ ë¡œë“œ -->
    <script>
      <%= File.read(Rails.root.join('app', 'assets', 'javascripts', 'modules', 'api.js')).html_safe %>
    </script>
    
    <script>
      <%= File.read(Rails.root.join('app', 'assets', 'javascripts', 'modules', 'ui-components.js')).html_safe %>
    </script>
    
    <script>
      <%= File.read(Rails.root.join('app', 'assets', 'javascripts', 'modules', 'auth.js')).html_safe %>
    </script>
    
    <!-- ëª¨ë“ˆ ì¸ìŠ¤í„´ìŠ¤ëŠ” ê° ëª¨ë“ˆì—ì„œ ìë™ìœ¼ë¡œ ìƒì„±ë¨ -->
    
    <script>
      // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° UI ì—…ë°ì´íŠ¸
      function updateAuthUI() {
        const token = localStorage.getItem('auth_token');
        const userInfo = localStorage.getItem('user_info');
        const welcomeSpan = document.getElementById('user-welcome');
        const authButtons = document.getElementById('auth-buttons');
        
        if (token && userInfo) {
          try {
            const user = JSON.parse(userInfo);
            const roleDisplay = window.authManager ? window.authManager.getRoleDisplayName(user.role) : 'ì§ì›';
            
            welcomeSpan.textContent = `${user.name || 'ì‚¬ìš©ì'}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
            authButtons.innerHTML = `
              <button onclick="logout()" class="bg-red-500 text-white hover:bg-red-600 hover:shadow-md group flex items-center justify-center px-2 py-2 text-sm font-medium rounded-md w-full transition-all duration-200">
                <span class="sidebar-text font-semibold">ë¡œê·¸ì•„ì›ƒ</span>
              </button>
              <div class="mt-2 px-2 py-1 sidebar-text text-center">
                <span class="text-xs text-gray-500 font-medium">${roleDisplay}</span>
              </div>
            `;
            
            // ì¶•ì†Œ ëª¨ë“œ ì•„ì´ì½˜ë„ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            const collapsedIcon = document.getElementById('collapsed-user-icon');
            if (collapsedIcon) {
              collapsedIcon.innerHTML = `
                <button onclick="logout()" class="text-white bg-red-500 hover:bg-red-600 rounded-full p-2 transition-all duration-200 logout-mode" title="ë¡œê·¸ì•„ì›ƒ">
                  <span class="text-sm font-bold">OUT</span>
                </button>
              `;
              collapsedIcon.classList.add('logout-mode');
            }
          } catch (error) {
            console.error('ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì˜¤ë¥˜:', error);
            showLoginButton();
          }
        } else {
          showLoginButton();
        }
      }
      
      function showLoginButton() {
        const welcomeSpan = document.getElementById('user-welcome');
        const authButtons = document.getElementById('auth-buttons');
        welcomeSpan.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤';
        authButtons.innerHTML = `
          <a href="/login" class="text-gray-700 hover:bg-white hover:text-blue-600 hover:shadow-sm group flex items-center px-2 py-2 text-sm font-medium rounded-md transition-all duration-200">
            <span class="sidebar-icon mr-3">ğŸ”‘</span>
            <span class="sidebar-text">ë¡œê·¸ì¸</span>
          </a>
        `;
        
        // ì¶•ì†Œ ëª¨ë“œ ì•„ì´ì½˜ì„ ê¸°ë³¸ ìƒíƒœë¡œ ë³µì›
        const collapsedIcon = document.getElementById('collapsed-user-icon');
        if (collapsedIcon) {
          collapsedIcon.innerHTML = `
            <a href="#" class="text-gray-600 hover:text-gray-800 hover:bg-white rounded-full p-2 transition-all duration-200" title="ì‚¬ìš©ì ë©”ë‰´">
              <span class="text-xl">ğŸ‘¤</span>
            </a>
          `;
          collapsedIcon.classList.remove('logout-mode');
        }
      }
      
      // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
      async function logout() {
        if (window.authManager) {
          await window.authManager.logout();
        } else {
          localStorage.removeItem('auth_token');
          localStorage.removeItem('user_info');
        }
        window.location.href = '/login';
      }
      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ìƒíƒœ í™•ì¸
      document.addEventListener('DOMContentLoaded', function() {
        updateAuthUI();
        highlightCurrentPage();
      });
      
      // í˜„ì¬ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” ì‚¬ì´ë“œë°” ë©”ë‰´ í•˜ì´ë¼ì´íŠ¸
      function highlightCurrentPage() {
        const currentPath = window.location.pathname;
        const sidebarLinks = document.querySelectorAll('nav a[href]');
        
        // ëª¨ë“  ë§í¬ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
        sidebarLinks.forEach(link => {
          link.classList.remove('bg-blue-100', 'text-blue-900');
          link.classList.add('text-gray-600', 'hover:bg-gray-50', 'hover:text-gray-900');
        });
        
        // í˜„ì¬ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” ë§í¬ì— active í´ë˜ìŠ¤ ì¶”ê°€
        sidebarLinks.forEach(link => {
          const href = link.getAttribute('href');
          
          // ì •í™•í•œ ê²½ë¡œ ë§¤ì¹­ ë˜ëŠ” ê²½ë¡œê°€ í¬í•¨ëœ ê²½ìš° (ëŒ€ì‹œë³´ë“œëŠ” ì •í™•íˆ ë§¤ì¹­)
          if (currentPath === href || (href !== '/dashboard' && href !== '#' && currentPath.startsWith(href))) {
            link.classList.remove('text-gray-600', 'hover:bg-gray-50', 'hover:text-gray-900');
            link.classList.add('bg-blue-100', 'text-blue-900');
          }
        });
        
        // ëŒ€ì‹œë³´ë“œê°€ ê¸°ë³¸ í™œì„±í™”ë  ê²½ìš° ì²˜ë¦¬
        if (currentPath === '/' || currentPath === '') {
          const dashboardLink = document.querySelector('nav a[href="/dashboard"]');
          if (dashboardLink) {
            dashboardLink.classList.remove('text-gray-600', 'hover:bg-gray-50', 'hover:text-gray-900');
            dashboardLink.classList.add('bg-blue-100', 'text-blue-900');
          }
        }
      }
      
      // ì‚¬ì´ë“œë°” í† ê¸€ ê¸°ëŠ¥ (ë°ìŠ¤í¬í†±)
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const isCollapsed = sidebar.getAttribute('data-collapsed') === 'true';
        
        if (isCollapsed) {
          sidebar.setAttribute('data-collapsed', 'false');
          mainContent.classList.remove('lg:ml-16');
          mainContent.classList.add('lg:ml-64');
          localStorage.setItem('sidebar-collapsed', 'false');
        } else {
          sidebar.setAttribute('data-collapsed', 'true');
          mainContent.classList.remove('lg:ml-64');
          mainContent.classList.add('lg:ml-16');
          localStorage.setItem('sidebar-collapsed', 'true');
        }
      }
      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ì´ë“œë°” ìƒíƒœ ë³µì›
      document.addEventListener('DOMContentLoaded', function() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const savedState = localStorage.getItem('sidebar-collapsed');
        
        if (savedState === 'true') {
          sidebar.setAttribute('data-collapsed', 'true');
          mainContent.classList.remove('lg:ml-64');
          mainContent.classList.add('lg:ml-16');
        }
      });
      
      // ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” í† ê¸€ ê¸°ëŠ¥
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebar-overlay');
      
      if (sidebarToggle && sidebar && sidebarOverlay) {
        sidebarToggle.addEventListener('click', function() {
          sidebar.classList.toggle('sidebar-open');
          sidebarOverlay.classList.toggle('hidden');
        });
        
        sidebarOverlay.addEventListener('click', function() {
          sidebar.classList.remove('sidebar-open');
          sidebarOverlay.classList.add('hidden');
        });
      }

      // AI ì‚¬ì´ë“œë°” ê´€ë¦¬ì
      class AIChatManager {
        constructor() {
          this.chatMessages = document.getElementById('ai-chat-messages');
          this.chatInput = document.getElementById('ai-chat-input');
          this.sendButton = document.getElementById('ai-chat-send-btn');
          this.scrollIndicator = document.getElementById('scroll-indicator');
          this.isLoading = false;
          this.isUserScrolling = false;
          this.lastScrollTop = 0;
          this.currentPersona = 'default';
          this.currentSessionId = this.generateSessionId();
          this.conversationHistory = [];
          
          this.initializeScrollFeatures();
          this.initializePersona();
          this.restoreState(); // ìƒíƒœ ë³µì›
          this.loadConversationHistory();
        }
        
        // í˜ë¥´ì†Œë‚˜ ì´ˆê¸°í™”
        initializePersona() {
          // ì €ì¥ëœ í˜ë¥´ì†Œë‚˜ ë¶ˆëŸ¬ì˜¤ê¸°
          const savedPersona = localStorage.getItem('ai-persona') || 'default';
          this.setPersona(savedPersona, false);
        }
        
        // í˜ë¥´ì†Œë‚˜ ì„¤ì •
        setPersona(persona, showWelcome = true) {
          // í˜„ì¬ ìƒíƒœ ì €ì¥
          if (this.currentPersona !== persona) {
            this.saveState();
          }
          
          this.currentPersona = persona;
          localStorage.setItem('ai-persona', persona);
          
          // UI ì—…ë°ì´íŠ¸
          this.updatePersonaUI(persona);
          
          // ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸
          this.updateQuickActions(persona);
          
          // ìƒˆë¡œìš´ ì„¸ì…˜ ID ìƒì„±
          this.currentSessionId = this.generateSessionId();
          
          // í˜ë¥´ì†Œë‚˜ë³„ ëŒ€í™” ê¸°ë¡ ë¡œë“œ
          this.loadConversationHistory();
          
          // í™˜ì˜ ë©”ì‹œì§€ (í˜ë¥´ì†Œë‚˜ ë³€ê²½ ì‹œ)
          if (showWelcome) {
            this.showPersonaWelcome(persona);
          }
        }
        
        // í˜ë¥´ì†Œë‚˜ UI ì—…ë°ì´íŠ¸
        updatePersonaUI(persona) {
          const avatarEl = document.getElementById('persona-avatar');
          const headerEl = document.getElementById('ai-sidebar-header');
          const titleEl = document.getElementById('persona-title');
          const selectorEl = document.getElementById('persona-selector');
          
          if (!avatarEl || !headerEl || !titleEl || !selectorEl) return;
          
          // í˜ë¥´ì†Œë‚˜ ì •ë³´
          const personas = {
            default: { 
              icon: 'ğŸ¤–', 
              title: 'ì¼ë°˜ AI ì–´ì‹œìŠ¤í„´íŠ¸', 
              class: 'persona-default',
              description: `
                <div class="space-y-2">
                  <div class="font-semibold text-purple-300">ğŸ¤– ì¼ë°˜ AI ì–´ì‹œìŠ¤í„´íŠ¸</div>
                  <div class="text-gray-300">ë³‘ì› ì—…ë¬´ ì „ë°˜ì— ëŒ€í•œ ë„ì›€ì„ ì œê³µí•˜ëŠ” ë²”ìš© AIì…ë‹ˆë‹¤.</div>
                  <div class="space-y-1">
                    <div class="text-yellow-300 font-medium">ì£¼ìš” ê¸°ëŠ¥:</div>
                    <ul class="list-disc list-inside space-y-1 text-gray-300">
                      <li>ì‹œìŠ¤í…œ ì‚¬ìš©ë²• ì•ˆë‚´</li>
                      <li>ì—…ë¬´ í”„ë¡œì„¸ìŠ¤ ì§ˆë¬¸ ë‹µë³€</li>
                      <li>ì¼ë°˜ì ì¸ ë³‘ì› ê´€ë¦¬ ìƒë‹´</li>
                      <li>ê¸°ë³¸ì ì¸ ì •ë³´ ê²€ìƒ‰ ì§€ì›</li>
                    </ul>
                  </div>
                </div>
              `
            },
            doctor: { 
              icon: 'ğŸ©º', 
              title: 'ì˜ë£Œ ì „ë¬¸ ì–´ì‹œìŠ¤í„´íŠ¸', 
              class: 'persona-doctor',
              description: `
                <div class="space-y-2">
                  <div class="font-semibold text-green-300">ğŸ©º ë‹¥í„° ê¹€</div>
                  <div class="text-gray-300">ì¹œê·¼í•˜ë©´ì„œë„ ì „ë¬¸ì ì¸ ì˜ë£Œì§„ ê´€ì ì˜ ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤.</div>
                  <div class="space-y-1">
                    <div class="text-yellow-300 font-medium">ì „ë¬¸ ë¶„ì•¼:</div>
                    <ul class="list-disc list-inside space-y-1 text-gray-300">
                      <li>ì§„ë£Œ í”„ë¡œì„¸ìŠ¤ ê°€ì´ë“œ</li>
                      <li>ì˜í•™ ì •ë³´ ì œê³µ (ì¼ë°˜ì ì¸ ë‚´ìš©)</li>
                      <li>í™˜ì ìƒë‹´ ë°©ë²•ë¡ </li>
                      <li>ì˜ë£Œì§„ ê°„ í˜‘ì—… ë°©ì•ˆ</li>
                    </ul>
                  </div>
                  <div class="text-blue-300 text-xs">ğŸ’¡ "í™˜ìë¶„ë“¤ì„ ìœ„í•´ì„œë¼ë©´~", "ì˜í•™ì ìœ¼ë¡œ ë³´ë©´ìš”~" ê°™ì€ ë”°ëœ»í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</div>
                </div>
              `
            },
            nurse: { 
              icon: 'ğŸ‘©â€âš•ï¸', 
              title: 'ê°„í˜¸ ì¼€ì–´ ì–´ì‹œìŠ¤í„´íŠ¸', 
              class: 'persona-nurse',
              description: `
                <div class="space-y-2">
                  <div class="font-semibold text-pink-300">ğŸ‘©â€âš•ï¸ ê°„í˜¸ì‚¬ ì´</div>
                  <div class="text-gray-300">ë”°ëœ»í•˜ê³  ì„¸ì‹¬í•œ ê°„í˜¸ì‚¬ì˜ ë§ˆìŒìœ¼ë¡œ ì‹¤ë¬´ì ì¸ ë„ì›€ì„ ë“œë¦½ë‹ˆë‹¤.</div>
                  <div class="space-y-1">
                    <div class="text-yellow-300 font-medium">ì „ë¬¸ ë¶„ì•¼:</div>
                    <ul class="list-disc list-inside space-y-1 text-gray-300">
                      <li>í™˜ì ì¼€ì–´ ë° ê°„í˜¸ ì—…ë¬´</li>
                      <li>ì¼ì • ê´€ë¦¬ ë° ì—…ë¬´ ì¡°ìœ¨</li>
                      <li>ì‘ê¸‰ ìƒí™© ëŒ€ì²˜ë²•</li>
                      <li>ê°„í˜¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë° í”„ë¡œí† ì½œ</li>
                    </ul>
                  </div>
                  <div class="text-blue-300 text-xs">ğŸ’¡ "ê±±ì •í•˜ì§€ ë§ˆì„¸ìš”~", "ì œê°€ ë„ì™€ë“œë¦´ê²Œìš”!" ê°™ì€ ë°°ë ¤ì‹¬ ê¹Šì€ ë§íˆ¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</div>
                </div>
              `
            },
            manager: { 
              icon: 'ğŸ’¼', 
              title: 'ì—…ë¬´ ê´€ë¦¬ ì–´ì‹œìŠ¤í„´íŠ¸', 
              class: 'persona-manager',
              description: `
                <div class="space-y-2">
                  <div class="font-semibold text-orange-300">ğŸ’¼ ë§¤ë‹ˆì € ë°•</div>
                  <div class="text-gray-300">íš¨ìœ¨ì ì´ê³  ì²´ê³„ì ì¸ ê´€ë¦¬ì ê´€ì ì—ì„œ ì—…ë¬´ ìµœì í™”ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</div>
                  <div class="space-y-1">
                    <div class="text-yellow-300 font-medium">ì „ë¬¸ ë¶„ì•¼:</div>
                    <ul class="list-disc list-inside space-y-1 text-gray-300">
                      <li>ì—…ë¬´ ê´€ë¦¬ ë° í”„ë¡œì„¸ìŠ¤ ê°œì„ </li>
                      <li>í†µê³„ ë¶„ì„ ë° ì„±ê³¼ ì¸¡ì •</li>
                      <li>ì‹œìŠ¤í…œ ìš´ì˜ ë° ìµœì í™”</li>
                      <li>ì§ì› ê´€ë¦¬ ë° ì¡°ì§ ìš´ì˜</li>
                    </ul>
                  </div>
                  <div class="text-blue-300 text-xs">ğŸ’¡ "ì—…ë¬´ íš¨ìœ¨ì„ ìœ„í•´", "ì‹œìŠ¤í…œì ìœ¼ë¡œ ì ‘ê·¼í•˜ë©´" ê°™ì€ ë…¼ë¦¬ì ì¸ ë§íˆ¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</div>
                </div>
              `
            },
            tech: { 
              icon: 'ğŸ”§', 
              title: 'ê¸°ìˆ  ì§€ì› ì–´ì‹œìŠ¤í„´íŠ¸', 
              class: 'persona-tech',
              description: `
                <div class="space-y-2">
                  <div class="font-semibold text-gray-300">ğŸ”§ í…Œí‚¤</div>
                  <div class="text-gray-300">ë˜‘ë˜‘í•˜ê³  ë…¼ë¦¬ì ì¸ IT ì „ë¬¸ê°€ë¡œì„œ ê¸°ìˆ ì  ë¬¸ì œí•´ê²°ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤.</div>
                  <div class="space-y-1">
                    <div class="text-yellow-300 font-medium">ì „ë¬¸ ë¶„ì•¼:</div>
                    <ul class="list-disc list-inside space-y-1 text-gray-300">
                      <li>ì‹œìŠ¤í…œ ì‚¬ìš©ë²• ë° ê¸°ìˆ  ì§€ì›</li>
                      <li>ë¬¸ì œ ì§„ë‹¨ ë° í•´ê²°</li>
                      <li>ë°ì´í„° ë¶„ì„ ë° ë³´ê³ ì„œ</li>
                      <li>IT ì¸í”„ë¼ ë° ë³´ì•ˆ</li>
                    </ul>
                  </div>
                  <div class="text-blue-300 text-xs">ğŸ’¡ "ê¸°ìˆ ì ìœ¼ë¡œëŠ”", "ë°ì´í„°ë¥¼ ë³´ë©´" ê°™ì€ ì •í™•í•˜ê³  ëª…í™•í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</div>
                </div>
              `
            }
          };
          
          const personaInfo = personas[persona] || personas.default;
          
          // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
          avatarEl.classList.add('persona-transition');
          setTimeout(() => avatarEl.classList.remove('persona-transition'), 600);
          
          // ì•„ë°”íƒ€ ë° í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
          avatarEl.textContent = personaInfo.icon;
          titleEl.textContent = personaInfo.title;
          selectorEl.value = persona;
          
          // íˆ´íŒ ë‚´ìš© ì—…ë°ì´íŠ¸
          const tooltipContent = document.getElementById('persona-tooltip-content');
          if (tooltipContent) {
            tooltipContent.innerHTML = personaInfo.description;
          }
          
          // í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
          headerEl.className = `h-16 px-4 border-b border-gray-200 flex-shrink-0 transition-all duration-500 ${personaInfo.class}`;
          avatarEl.className = `w-10 h-10 rounded-full flex items-center justify-center text-xl transition-all duration-300 ${personaInfo.class}`;
        }
        
        // ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        updateQuickActions(persona) {
          const quickActionsEl = document.getElementById('quick-actions');
          if (!quickActionsEl) return;
          
          const actionSets = {
            default: [
              { text: 'í™˜ì ì •ë³´ ê²€ìƒ‰', message: 'í™˜ì ì •ë³´ ê²€ìƒ‰', color: 'blue' },
              { text: 'ì˜¤ëŠ˜ ì¼ì • í™•ì¸', message: 'ì˜¤ëŠ˜ ì¼ì • í™•ì¸', color: 'green' },
              { text: 'í†µê³„ ìš”ì•½', message: 'í†µê³„ ìš”ì•½', color: 'purple' }
            ],
            doctor: [
              { text: 'ì§„ë£Œ ê°€ì´ë“œ', message: 'ì§„ë£Œ ê´€ë ¨ ê°€ì´ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”', color: 'green' },
              { text: 'ì˜í•™ ì •ë³´', message: 'ì˜í•™ ì •ë³´ë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”', color: 'emerald' },
              { text: 'í™˜ì ìƒë‹´', message: 'í™˜ì ìƒë‹´ ë°©ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”', color: 'teal' }
            ],
            nurse: [
              { text: 'ê°„í˜¸ ì²´í¬ë¦¬ìŠ¤íŠ¸', message: 'ê°„í˜¸ ì—…ë¬´ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”', color: 'pink' },
              { text: 'í™˜ì ì¼€ì–´', message: 'í™˜ì ì¼€ì–´ ë°©ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”', color: 'rose' },
              { text: 'ì‘ê¸‰ ìƒí™©', message: 'ì‘ê¸‰ ìƒí™© ëŒ€ì²˜ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”', color: 'red' }
            ],
            manager: [
              { text: 'ì—…ë¬´ ê´€ë¦¬', message: 'ì—…ë¬´ ê´€ë¦¬ ë°©ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”', color: 'indigo' },
              { text: 'ì„±ê³¼ ë¶„ì„', message: 'ì„±ê³¼ ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”', color: 'blue' },
              { text: 'ì§ì› ê´€ë¦¬', message: 'ì§ì› ê´€ë¦¬ ê°€ì´ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”', color: 'violet' }
            ],
            tech: [
              { text: 'ì‹œìŠ¤í…œ ì‚¬ìš©ë²•', message: 'ì‹œìŠ¤í…œ ì‚¬ìš©ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”', color: 'gray' },
              { text: 'ê¸°ìˆ  ì§€ì›', message: 'ê¸°ìˆ ì  ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”', color: 'slate' },
              { text: 'ì˜¤ë¥˜ ì§„ë‹¨', message: 'ì‹œìŠ¤í…œ ì˜¤ë¥˜ë¥¼ ì§„ë‹¨í•´ì£¼ì„¸ìš”', color: 'zinc' }
            ]
          };
          
          const actions = actionSets[persona] || actionSets.default;
          
          quickActionsEl.innerHTML = actions.map(action => 
            `<button onclick="sendQuickMessage('${action.message}')" class="px-3 py-1 bg-${action.color}-100 text-${action.color}-700 rounded-full text-xs hover:bg-${action.color}-200 transition-colors">
              ${action.text}
            </button>`
          ).join('');
        }
        
        // í˜ë¥´ì†Œë‚˜ í™˜ì˜ ë©”ì‹œì§€
        showPersonaWelcome(persona) {
          const welcomeMessages = {
            default: 'ì•ˆë…•í•˜ì„¸ìš”! ì¼ë°˜ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?',
            doctor: 'ì•ˆë…•í•˜ì„¸ìš”! ë‹¥í„° ê¹€ì…ë‹ˆë‹¤. ì˜ë£Œ ê´€ë ¨ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ì£¼ì„¸ìš”. ğŸ‘©â€âš•ï¸',
            nurse: 'ì•ˆë…•í•˜ì„¸ìš”! ê°„í˜¸ì‚¬ ì´ì…ë‹ˆë‹¤. í™˜ì ì¼€ì–´ì™€ ê°„í˜¸ ì—…ë¬´ì— ëŒ€í•´ ë„ì›€ì„ ë“œë¦´ê²Œìš”! ğŸ’•',
            manager: 'ì•ˆë…•í•˜ì„¸ìš”! ë§¤ë‹ˆì € ë°•ì…ë‹ˆë‹¤. íš¨ìœ¨ì ì¸ ì—…ë¬´ ê´€ë¦¬ë¥¼ ìœ„í•´ ìµœì„ ì„ ë‹¤í•˜ê² ìŠµë‹ˆë‹¤. ğŸ“Š',
            tech: 'ì•ˆë…•í•˜ì„¸ìš”! í…Œí‚¤ì…ë‹ˆë‹¤. ê¸°ìˆ ì ì¸ ë¬¸ì œë‚˜ ì‹œìŠ¤í…œ ê´€ë ¨ ì§ˆë¬¸ì„ í•´ê²°í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤. âš™ï¸'
          };
          
          const message = welcomeMessages[persona] || welcomeMessages.default;
          this.addMessage(message, false);
        }
        
        // ìŠ¤í¬ë¡¤ ê¸°ëŠ¥ ì´ˆê¸°í™”
        initializeScrollFeatures() {
          if (!this.chatMessages) return;
          
          // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          this.chatMessages.addEventListener('scroll', () => {
            this.handleScroll();
          });
          
          // ìŠ¤í¬ë¡¤ ì¸ë””ì¼€ì´í„° í´ë¦­ ì´ë²¤íŠ¸
          if (this.scrollIndicator) {
            this.scrollIndicator.addEventListener('click', () => {
              this.scrollToBottom(true);
            });
          }
          
          // ë§ˆìš°ìŠ¤ íœ  ê°ì§€
          this.chatMessages.addEventListener('wheel', () => {
            this.isUserScrolling = true;
            clearTimeout(this.scrollTimeout);
            this.scrollTimeout = setTimeout(() => {
              this.isUserScrolling = false;
            }, 1000);
          });
        }
        
        // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
        handleScroll() {
          const scrollTop = this.chatMessages.scrollTop;
          const scrollHeight = this.chatMessages.scrollHeight;
          const clientHeight = this.chatMessages.clientHeight;
          const isAtBottom = scrollTop + clientHeight >= scrollHeight - 10;
          
          // ìŠ¤í¬ë¡¤ ì¸ë””ì¼€ì´í„° í‘œì‹œ/ìˆ¨ê¹€
          if (this.scrollIndicator) {
            if (!isAtBottom && !this.isLoading) {
              this.scrollIndicator.classList.add('show');
            } else {
              this.scrollIndicator.classList.remove('show');
            }
          }
          
          this.lastScrollTop = scrollTop;
        }

        // Markdown ë Œë”ë§ í•¨ìˆ˜
        renderMarkdown(content) {
          try {
            // marked.jsë¥¼ ì‚¬ìš©í•˜ì—¬ markdownì„ HTMLë¡œ ë³€í™˜
            const rendered = marked.parse(content, {
              breaks: true,        // ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
              gfm: true,          // GitHub Flavored Markdown ì§€ì›
              sanitize: false,    // HTML íƒœê·¸ í—ˆìš© (DOMPurify ì‚¬ìš© ê¶Œì¥)
              smartypants: true   // ë”°ì˜´í‘œ, ëŒ€ì‹œ ë“±ì„ íƒ€ì´í¬ê·¸ë˜í”¼ ë¬¸ìë¡œ ë³€í™˜
            });
            
            // ê¸°ë³¸ì ì¸ XSS ë°©ì§€ (ê°„ë‹¨í•œ ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ì œê±°)
            return rendered.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
          } catch (error) {
            console.error('Markdown rendering error:', error);
            // ì—ëŸ¬ ë°œìƒ ì‹œ ì›ë³¸ í…ìŠ¤íŠ¸ ë°˜í™˜
            return content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
          }
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        addMessage(content, isUser = false) {
          const messageContainer = this.chatMessages.querySelector('.space-y-4');
          const messageElement = document.createElement('div');
          
          if (isUser) {
            messageElement.innerHTML = `
              <div class="flex items-start space-x-2 justify-end">
                <div class="flex-1 max-w-xs">
                  <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg p-3">
                    <p class="text-sm">${content}</p>
                  </div>
                  <div class="text-xs text-gray-500 mt-1 text-right">ë°©ê¸ˆ ì „</div>
                </div>
                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0">
                  <span class="text-gray-600 text-sm">ğŸ‘¤</span>
                </div>
              </div>
            `;
          } else {
            // í˜„ì¬ í˜ë¥´ì†Œë‚˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const personas = {
              default: { icon: 'ğŸ¤–', class: 'persona-default' },
              doctor: { icon: 'ğŸ©º', class: 'persona-doctor' },
              nurse: { icon: 'ğŸ‘©â€âš•ï¸', class: 'persona-nurse' },
              manager: { icon: 'ğŸ’¼', class: 'persona-manager' },
              tech: { icon: 'ğŸ”§', class: 'persona-tech' }
            };
            
            const personaInfo = personas[this.currentPersona] || personas.default;
            
            messageElement.innerHTML = `
              <div class="flex items-start space-x-2">
                <div class="w-8 h-8 ${personaInfo.class} rounded-full flex items-center justify-center flex-shrink-0">
                  <span class="text-white text-sm">${personaInfo.icon}</span>
                </div>
                <div class="flex-1">
                  <div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
                    <div class="markdown-content text-sm text-gray-800">${this.renderMarkdown(content)}</div>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">ë°©ê¸ˆ ì „</div>
                </div>
              </div>
            `;
          }
          
          messageContainer.appendChild(messageElement);
          this.scrollToBottom();
        }

        // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
        showLoadingMessage() {
          const messageContainer = this.chatMessages.querySelector('.space-y-4');
          const loadingElement = document.createElement('div');
          loadingElement.className = 'ai-loading-message';
          
          const personas = {
            default: { icon: 'ğŸ¤–', class: 'persona-default' },
            doctor: { icon: 'ğŸ©º', class: 'persona-doctor' },
            nurse: { icon: 'ğŸ‘©â€âš•ï¸', class: 'persona-nurse' },
            manager: { icon: 'ğŸ’¼', class: 'persona-manager' },
            tech: { icon: 'ğŸ”§', class: 'persona-tech' }
          };
          
          const personaInfo = personas[this.currentPersona] || personas.default;
          
          loadingElement.innerHTML = `
            <div class="flex items-start space-x-2">
              <div class="w-8 h-8 ${personaInfo.class} rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-white text-sm">${personaInfo.icon}</span>
              </div>
              <div class="flex-1">
                <div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
                  <div class="flex items-center space-x-2">
                    <div class="typing-indicator">
                      <span></span>
                      <span></span>
                      <span></span>
                    </div>
                    <span class="text-sm text-gray-600">ìƒê°í•˜ëŠ” ì¤‘...</span>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          messageContainer.appendChild(loadingElement);
          this.scrollToBottom();
          return loadingElement;
        }

        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
        removeLoadingMessage() {
          const loadingMessage = this.chatMessages.querySelector('.ai-loading-message');
          if (loadingMessage) {
            loadingMessage.remove();
          }
        }

        // ìŠ¤í¬ë¡¤ì„ í•˜ë‹¨ìœ¼ë¡œ (ê°œì„ ëœ ë²„ì „)
        scrollToBottom(force = false) {
          if (!this.chatMessages) return;
          
          // ì‚¬ìš©ìê°€ ìŠ¤í¬ë¡¤ ì¤‘ì´ê³  ê°•ì œê°€ ì•„ë‹ˆë©´ ìë™ ìŠ¤í¬ë¡¤ ì•ˆí•¨
          if (this.isUserScrolling && !force) return;
          
          // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤
          const scrollOptions = {
            top: this.chatMessages.scrollHeight,
            behavior: force ? 'auto' : 'smooth'
          };
          
          this.chatMessages.scrollTo(scrollOptions);
          
          // ìŠ¤í¬ë¡¤ ì¸ë””ì¼€ì´í„° ìˆ¨ê¹€
          if (this.scrollIndicator) {
            this.scrollIndicator.classList.remove('show');
          }
        }
        
        // íŠ¹ì • ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤
        scrollToMessage(messageElement) {
          if (!messageElement || !this.chatMessages) return;
          
          messageElement.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
          
          // ë©”ì‹œì§€ í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼
          messageElement.style.backgroundColor = 'rgba(147, 51, 234, 0.1)';
          setTimeout(() => {
            messageElement.style.backgroundColor = '';
          }, 2000);
        }
        
        // ë©”ì‹œì§€ ì˜ì—­ ë†’ì´ ìë™ ì¡°ì •
        adjustHeight() {
          if (!this.chatMessages) return;
          
          const aiSidebar = document.getElementById('ai-sidebar');
          const sidebarHeight = aiSidebar ? aiSidebar.clientHeight : 0;
          const headerHeight = 64; // í—¤ë” ë†’ì´
          const inputHeight = 120; // ì…ë ¥ ì˜ì—­ ë†’ì´
          
          const maxHeight = sidebarHeight - headerHeight - inputHeight;
          this.chatMessages.style.maxHeight = `${maxHeight}px`;
        }

        // ëŒ€í™” ê¸°ë¡ ë¡œë“œ
        async loadConversationHistory() {
          try {
            const response = await fetch(`${window.BACKEND_API_URL}/conversation_histories/recent_context?persona=${this.currentPersona}&limit=20`, {
              headers: {
                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
              }
            });

            if (response.ok) {
              const data = await response.json();
              this.conversationHistory = data.data || [];
              this.renderConversationHistory();
            }
          } catch (error) {
            console.error('Failed to load conversation history:', error);
          }
        }

        // ëŒ€í™” ê¸°ë¡ ë Œë”ë§
        renderConversationHistory() {
          const messageContainer = this.chatMessages.querySelector('.space-y-4');
          
          // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±° (í™˜ì˜ ë©”ì‹œì§€ ì œì™¸í•˜ê³ )
          const existingMessages = messageContainer.querySelectorAll('.message-history');
          existingMessages.forEach(msg => msg.remove());
          
          // ìµœê·¼ 5ê°œ ë©”ì‹œì§€ë§Œ í‘œì‹œ
          const recentMessages = this.conversationHistory.slice(-10);
          
          recentMessages.forEach(history => {
            const messageElement = document.createElement('div');
            messageElement.className = 'message-history';
            
            if (history.message_type === 'user') {
              messageElement.innerHTML = `
                <div class="flex items-start space-x-2 justify-end">
                  <div class="flex-1 max-w-xs">
                    <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg p-3">
                      <p class="text-sm">${history.content}</p>
                    </div>
                    <div class="text-xs text-gray-500 mt-1 text-right">${this.formatTimestamp(history.timestamp)}</div>
                  </div>
                  <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-gray-600 text-sm">ğŸ‘¤</span>
                  </div>
                </div>
              `;
            } else {
              const personas = {
                default: { icon: 'ğŸ¤–', class: 'persona-default' },
                doctor: { icon: 'ğŸ©º', class: 'persona-doctor' },
                nurse: { icon: 'ğŸ‘©â€âš•ï¸', class: 'persona-nurse' },
                manager: { icon: 'ğŸ’¼', class: 'persona-manager' },
                tech: { icon: 'ğŸ”§', class: 'persona-tech' }
              };
              
              const personaInfo = personas[history.persona] || personas.default;
              
              messageElement.innerHTML = `
                <div class="flex items-start space-x-2">
                  <div class="w-8 h-8 ${personaInfo.class} rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-white text-sm">${personaInfo.icon}</span>
                  </div>
                  <div class="flex-1">
                    <div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
                      <p class="text-sm text-gray-800">${history.content}</p>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">${this.formatTimestamp(history.timestamp)}</div>
                  </div>
                </div>
              `;
            }
            
            messageContainer.appendChild(messageElement);
          });
          
          this.scrollToBottom();
        }

        // íƒ€ì„ìŠ¤íƒ¬í”„ í¬ë§·íŒ…
        formatTimestamp(timestamp) {
          const date = new Date(timestamp);
          const now = new Date();
          const diffInMinutes = Math.floor((now - date) / (1000 * 60));
          
          if (diffInMinutes < 1) return 'ë°©ê¸ˆ ì „';
          if (diffInMinutes < 60) return `${diffInMinutes}ë¶„ ì „`;
          if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}ì‹œê°„ ì „`;
          
          return date.toLocaleDateString('ko-KR', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        }

        // ì„¸ì…˜ ID ìƒì„±
        generateSessionId() {
          return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async sendMessage(message) {
          if (!message.trim() || this.isLoading) return;

          this.isLoading = true;
          this.updateSendButton(true);
          
          // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
          this.addMessage(message, true);
          this.chatInput.value = '';
          
          // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
          const loadingElement = this.showLoadingMessage();
          
          try {
            const response = await fetch(`${window.BACKEND_API_URL}/ai/chat`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
              },
              body: JSON.stringify({ 
                message: message,
                persona: this.currentPersona,
                session_id: this.currentSessionId
              })
            });

            if (!response.ok) {
              throw new Error('AI ì„œë¹„ìŠ¤ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            const data = await response.json();
            
            // ì„¸ì…˜ ID ì—…ë°ì´íŠ¸
            if (data.session_id) {
              this.currentSessionId = data.session_id;
            }
            
            // ë¡œë”© ë©”ì‹œì§€ ì œê±°
            this.removeLoadingMessage();
            
            // AI ì‘ë‹µ ì¶”ê°€
            this.addMessage(data.response || 'ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            
            // ìƒíƒœ ì €ì¥
            this.saveState();
            
          } catch (error) {
            console.error('AI Chat Error:', error);
            this.removeLoadingMessage();
            this.addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ AI ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          } finally {
            this.isLoading = false;
            this.updateSendButton(false);
          }
        }

        // ìƒˆ ëŒ€í™” ì‹œì‘
        startNewConversation() {
          // ìƒˆ ì„¸ì…˜ ID ìƒì„±
          this.currentSessionId = this.generateSessionId();
          
          // ì±„íŒ… ì˜ì—­ ì´ˆê¸°í™”
          const messageContainer = this.chatMessages.querySelector('.space-y-4');
          messageContainer.innerHTML = `
            <!-- í™˜ì˜ ë©”ì‹œì§€ -->
            <div class="flex items-start space-x-2">
              <div class="w-8 h-8 persona-default rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-white text-sm">ğŸ¤–</span>
              </div>
              <div class="flex-1">
                <div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
                  <p class="text-sm text-gray-800">ìƒˆë¡œìš´ ëŒ€í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</p>
                </div>
                <div class="text-xs text-gray-500 mt-1">ë°©ê¸ˆ ì „</div>
              </div>
            </div>
          `;
          
          // ìŠ¤í¬ë¡¤ ìµœì í™”
          this.scrollToBottom(true);
          
          // í† ìŠ¤íŠ¸ ì•Œë¦¼
          if (window.toast) {
            window.toast.success('ìƒˆë¡œìš´ ëŒ€í™”ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
          }
        }

        // ì „ì†¡ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateSendButton(loading) {
          if (loading) {
            this.sendButton.disabled = true;
            this.sendButton.innerHTML = `
              <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            `;
          } else {
            this.sendButton.disabled = false;
            this.sendButton.innerHTML = `
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
            `;
          }
        }

        // localStorageì— ìƒíƒœ ì €ì¥
        saveState() {
          try {
            const state = {
              currentPersona: this.currentPersona,
              currentSessionId: this.currentSessionId,
              messages: this.getDisplayedMessages(),
              timestamp: Date.now()
            };
            
            const stateKey = `ai-chat-state-${this.currentPersona}`;
            localStorage.setItem(stateKey, JSON.stringify(state));
          } catch (error) {
            console.error('Failed to save chat state:', error);
          }
        }

        // localStorageì—ì„œ ìƒíƒœ ë³µì›
        restoreState() {
          try {
            const stateKey = `ai-chat-state-${this.currentPersona}`;
            const savedState = localStorage.getItem(stateKey);
            
            if (savedState) {
              const state = JSON.parse(savedState);
              
              // ìƒíƒœê°€ 24ì‹œê°„ ì´ë‚´ì˜ ê²ƒì¸ì§€ í™•ì¸
              const dayAgo = Date.now() - (24 * 60 * 60 * 1000);
              if (state.timestamp > dayAgo) {
                this.currentSessionId = state.currentSessionId || this.generateSessionId();
                this.restoreMessages(state.messages || []);
              }
            }
          } catch (error) {
            console.error('Failed to restore chat state:', error);
          }
        }

        // í˜„ì¬ í‘œì‹œëœ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
        getDisplayedMessages() {
          const messageContainer = this.chatMessages.querySelector('.space-y-4');
          const messages = [];
          
          messageContainer.querySelectorAll('.message-history, div').forEach(element => {
            const isUser = element.querySelector('.justify-end');
            const isAI = element.querySelector('.persona-default, .persona-doctor, .persona-nurse, .persona-manager, .persona-tech');
            
            if (isUser || isAI) {
              const contentEl = isUser ? 
                element.querySelector('.bg-gradient-to-r p') :
                element.querySelector('.markdown-content, .text-sm.text-gray-800');
              
              if (contentEl) {
                messages.push({
                  content: contentEl.textContent || contentEl.innerHTML,
                  isUser: !!isUser,
                  persona: this.currentPersona,
                  timestamp: Date.now()
                });
              }
            }
          });
          
          return messages;
        }

        // ë©”ì‹œì§€ ë³µì›
        restoreMessages(messages) {
          const messageContainer = this.chatMessages.querySelector('.space-y-4');
          messageContainer.innerHTML = '';
          
          messages.forEach(msg => {
            this.addMessage(msg.content, msg.isUser);
          });
          
          this.scrollToBottom();
        }

        // í˜ë¥´ì†Œë‚˜ ë³€ê²½ ì‹œ ì„¸ì…˜ ì €ì¥ ë° ë³µì›
        changePersona(newPersona) {
          // í˜„ì¬ ìƒíƒœ ì €ì¥
          this.saveState();
          
          // í˜ë¥´ì†Œë‚˜ ë³€ê²½
          this.currentPersona = newPersona;
          this.currentSessionId = this.generateSessionId();
          
          // ìƒˆ í˜ë¥´ì†Œë‚˜ ìƒíƒœ ë³µì›
          this.restoreState();
          
          // ëŒ€í™” ê¸°ë¡ì´ ì—†ìœ¼ë©´ í™˜ì˜ ë©”ì‹œì§€ í‘œì‹œ
          const messageContainer = this.chatMessages.querySelector('.space-y-4');
          if (messageContainer.children.length === 0) {
            this.showPersonaWelcome(newPersona);
          }
          
          this.updatePersonaUI(newPersona);
          this.updateQuickActions(newPersona);
        }
      }

      // ì „ì—­ AI ì±„íŒ… ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
      window.aiChat = new AIChatManager();

      // AI ì‚¬ì´ë“œë°” í† ê¸€ í•¨ìˆ˜
      function toggleAISidebar() {
        const aiSidebar = document.getElementById('ai-sidebar');
        const isHidden = aiSidebar.getAttribute('data-hidden') === 'true';
        
        if (isHidden) {
          aiSidebar.setAttribute('data-hidden', 'false');
          localStorage.setItem('ai-sidebar-hidden', 'false');
          
          // ì‚¬ì´ë“œë°”ê°€ ì—´ë¦´ ë•Œ ë†’ì´ ì¡°ì • ë° ìŠ¤í¬ë¡¤ ìµœì í™”
          setTimeout(() => {
            if (window.aiChat) {
              window.aiChat.adjustHeight();
              window.aiChat.scrollToBottom(true);
            }
          }, 300);
        } else {
          aiSidebar.setAttribute('data-hidden', 'true');
          localStorage.setItem('ai-sidebar-hidden', 'true');
        }
      }

      // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
      function sendChatMessage() {
        const input = document.getElementById('ai-chat-input');
        const message = input.value.trim();
        if (message && window.aiChat) {
          window.aiChat.sendMessage(message);
        }
      }

      // ì—”í„°í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
      function handleChatInput(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          sendChatMessage();
        }
      }

      // ë¹ ë¥¸ ë©”ì‹œì§€ ì „ì†¡
      function sendQuickMessage(message) {
        if (window.aiChat) {
          window.aiChat.sendMessage(message);
        }
      }
      
      // í˜ë¥´ì†Œë‚˜ ë³€ê²½
      function changePersona(persona) {
        if (window.aiChat) {
          window.aiChat.changePersona(persona);
        }
      }
      
      // ìƒˆ ëŒ€í™” ì‹œì‘
      function startNewConversation() {
        if (window.aiChat) {
          window.aiChat.startNewConversation();
        }
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ AI ì‚¬ì´ë“œë°” ìƒíƒœ ë³µì›
      document.addEventListener('DOMContentLoaded', function() {
        const aiSidebar = document.getElementById('ai-sidebar');
        const savedState = localStorage.getItem('ai-sidebar-hidden');
        
        if (savedState === 'false') {
          aiSidebar.setAttribute('data-hidden', 'false');
          setTimeout(() => {
            if (window.aiChat) {
              window.aiChat.adjustHeight();
            }
          }, 100);
        }
        
        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì¶”ê°€
        document.addEventListener('keydown', function(e) {
          // Ctrl + Shift + A: AI ì‚¬ì´ë“œë°” í† ê¸€
          if (e.ctrlKey && e.shiftKey && e.key === 'A') {
            e.preventDefault();
            toggleAISidebar();
          }
          
          // Ctrl + Shift + N: ìƒˆ ëŒ€í™” ì‹œì‘
          if (e.ctrlKey && e.shiftKey && e.key === 'N') {
            e.preventDefault();
            const aiSidebar = document.getElementById('ai-sidebar');
            if (aiSidebar && aiSidebar.getAttribute('data-hidden') === 'false') {
              startNewConversation();
            }
          }
          
          // ESC: AI ì‚¬ì´ë“œë°” ë‹«ê¸°
          if (e.key === 'Escape') {
            const aiSidebar = document.getElementById('ai-sidebar');
            if (aiSidebar && aiSidebar.getAttribute('data-hidden') === 'false') {
              toggleAISidebar();
            }
          }
        });
        
        // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ë†’ì´ ì¡°ì •
        window.addEventListener('resize', function() {
          if (window.aiChat) {
            window.aiChat.adjustHeight();
          }
        });
        
        // í˜ë¥´ì†Œë‚˜ ì •ë³´ íˆ´íŒ ì´ë²¤íŠ¸
        const infoIcon = document.getElementById('persona-info-icon');
        const tooltip = document.getElementById('persona-tooltip');
        
        if (infoIcon && tooltip) {
          let tooltipTimeout;
          
          infoIcon.addEventListener('mouseenter', function() {
            clearTimeout(tooltipTimeout);
            tooltip.classList.remove('opacity-0', 'invisible');
            tooltip.classList.add('opacity-100', 'visible');
          });
          
          infoIcon.addEventListener('mouseleave', function() {
            tooltipTimeout = setTimeout(() => {
              tooltip.classList.remove('opacity-100', 'visible');
              tooltip.classList.add('opacity-0', 'invisible');
            }, 300);
          });
          
          // íˆ´íŒì— ë§ˆìš°ìŠ¤ê°€ ì˜¬ë¼ê°€ë©´ ì‚¬ë¼ì§€ì§€ ì•Šë„ë¡
          tooltip.addEventListener('mouseenter', function() {
            clearTimeout(tooltipTimeout);
          });
          
          tooltip.addEventListener('mouseleave', function() {
            tooltip.classList.remove('opacity-100', 'visible');
            tooltip.classList.add('opacity-0', 'invisible');
          });
        }
      });
    </script>

    <!-- AI ì±„íŒ… ìŠ¤íƒ€ì¼ -->
    <style>
      /* íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì• ë‹ˆë©”ì´ì…˜ */
      .typing-indicator {
        display: flex;
        align-items: center;
        space-x: 1px;
      }
      
      .typing-indicator span {
        height: 4px;
        width: 4px;
        background: #9ca3af;
        border-radius: 50%;
        display: inline-block;
        margin-right: 2px;
        animation: typing 1.4s infinite ease-in-out;
      }
      
      .typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
      }
      
      .typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
      }
      
      @keyframes typing {
        0%, 80%, 100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }
      
      /* AI ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ ìŠ¤í¬ë¡¤ ê°œì„  */
      #ai-chat-messages {
        max-height: calc(100vh - 200px); /* í™”ë©´ ë†’ì´ì— ë§ì¶° ì¡°ì • */
        overflow-y: auto;
        overflow-x: hidden;
        scroll-behavior: smooth; /* ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
        scrollbar-width: thin; /* Firefox ì§€ì› */
        scrollbar-color: #cbd5e1 #f1f5f9; /* Firefox ì§€ì› */
      }
      
      /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ (Chrome, Safari, Edge) */
      #ai-chat-messages::-webkit-scrollbar {
        width: 8px;
      }
      
      #ai-chat-messages::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
        margin: 4px 0;
      }
      
      #ai-chat-messages::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom, #cbd5e1, #94a3b8);
        border-radius: 4px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
      }
      
      #ai-chat-messages::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(to bottom, #94a3b8, #64748b);
        transform: scale(1.1);
      }
      
      #ai-chat-messages::-webkit-scrollbar-thumb:active {
        background: linear-gradient(to bottom, #64748b, #475569);
      }
      
      /* ìŠ¤í¬ë¡¤ í˜ì´ë“œ íš¨ê³¼ */
      #ai-chat-messages::before {
        content: '';
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        height: 10px;
        background: linear-gradient(to bottom, white, transparent);
        z-index: 1;
        pointer-events: none;
      }
      
      #ai-chat-messages::after {
        content: '';
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        height: 10px;
        background: linear-gradient(to top, white, transparent);
        z-index: 1;
        pointer-events: none;
      }
      
      /* ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ ìµœì í™” */
      @media (max-width: 768px) {
        #ai-chat-messages {
          max-height: calc(100vh - 250px);
          -webkit-overflow-scrolling: touch; /* iOS ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
        }
        
        #ai-chat-messages::-webkit-scrollbar {
          width: 6px;
        }
      }
      
      /* ìŠ¤í¬ë¡¤ ì¸ë””ì¼€ì´í„° */
      .scroll-indicator {
        position: absolute;
        right: 12px;
        bottom: 80px;
        background: rgba(147, 51, 234, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s ease;
        pointer-events: none;
        z-index: 10;
      }
      
      .scroll-indicator.show {
        opacity: 1;
        transform: translateY(0);
      }
      
      /* í˜ë¥´ì†Œë‚˜ë³„ í—¤ë” ìŠ¤íƒ€ì¼ */
      .persona-default { background: linear-gradient(to right, #9333ea, #2563eb); }
      .persona-doctor { background: linear-gradient(to right, #059669, #047857); }
      .persona-nurse { background: linear-gradient(to right, #ec4899, #e11d48); }
      .persona-manager { background: linear-gradient(to right, #ea580c, #dc2626); }
      .persona-tech { background: linear-gradient(to right, #4b5563, #374151); }
      
      /* í˜ë¥´ì†Œë‚˜ë³„ ë©”ì‹œì§€ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
      .persona-default { background: linear-gradient(135deg, #a855f7, #3b82f6); }
      .persona-doctor { background: linear-gradient(135deg, #10b981, #059669); }
      .persona-nurse { background: linear-gradient(135deg, #f472b6, #ec4899); }
      .persona-manager { background: linear-gradient(135deg, #ea580c, #dc2626); }
      .persona-tech { background: linear-gradient(135deg, #6b7280, #4b5563); }
      
      /* í˜ë¥´ì†Œë‚˜ ì•„ë°”íƒ€ ìŠ¤íƒ€ì¼ */
      #persona-avatar.persona-default { background: linear-gradient(135deg, #a855f7, #3b82f6); }
      #persona-avatar.persona-doctor { background: linear-gradient(135deg, #10b981, #059669); }
      #persona-avatar.persona-nurse { background: linear-gradient(135deg, #f472b6, #ec4899); }
      #persona-avatar.persona-manager { background: linear-gradient(135deg, #ea580c, #dc2626); }
      #persona-avatar.persona-tech { background: linear-gradient(135deg, #6b7280, #4b5563); }
      
      /* Markdown ì»¨í…ì¸  ìŠ¤íƒ€ì¼ */
      .markdown-content {
        line-height: 1.6;
      }
      
      .markdown-content h1,
      .markdown-content h2,
      .markdown-content h3,
      .markdown-content h4,
      .markdown-content h5,
      .markdown-content h6 {
        font-weight: 600;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        color: #1f2937;
      }
      
      .markdown-content h1 { font-size: 1.5rem; }
      .markdown-content h2 { font-size: 1.3rem; }
      .markdown-content h3 { font-size: 1.1rem; }
      .markdown-content h4,
      .markdown-content h5,
      .markdown-content h6 { font-size: 1rem; }
      
      .markdown-content p {
        margin-bottom: 0.75rem;
      }
      
      .markdown-content ul,
      .markdown-content ol {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
      }
      
      .markdown-content li {
        margin-bottom: 0.25rem;
      }
      
      .markdown-content code {
        background-color: #f3f4f6;
        color: #e11d48;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-family: 'Courier New', monospace;
        font-size: 0.85em;
      }
      
      .markdown-content pre {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 0.75rem 0;
        overflow-x: auto;
        line-height: 1.4;
      }
      
      .markdown-content pre code {
        background-color: transparent;
        color: #374151;
        padding: 0;
        border-radius: 0;
        font-size: 0.875rem;
      }
      
      .markdown-content blockquote {
        border-left: 4px solid #e5e7eb;
        padding-left: 1rem;
        margin: 0.75rem 0;
        font-style: italic;
        color: #6b7280;
      }
      
      .markdown-content strong {
        font-weight: 600;
        color: #111827;
      }
      
      .markdown-content em {
        font-style: italic;
      }
      
      .markdown-content a {
        color: #2563eb;
        text-decoration: underline;
      }
      
      .markdown-content a:hover {
        color: #1d4ed8;
      }
      
      .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 0.75rem 0;
      }
      
      .markdown-content th,
      .markdown-content td {
        border: 1px solid #e5e7eb;
        padding: 0.5rem;
        text-align: left;
      }
      
      .markdown-content th {
        background-color: #f9fafb;
        font-weight: 600;
      }
      
      /* í˜ë¥´ì†Œë‚˜ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
      .persona-transition {
        animation: personaChange 0.6s ease-in-out;
      }
      
      @keyframes personaChange {
        0% { transform: scale(1) rotate(0deg); opacity: 1; }
        50% { transform: scale(1.1) rotate(180deg); opacity: 0.7; }
        100% { transform: scale(1) rotate(360deg); opacity: 1; }
      }
      
      /* í˜ë¥´ì†Œë‚˜ ì…€ë ‰í„° ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
      #persona-selector {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: white;
        font-weight: bold;
        padding: 4px 8px;
      }
      
      #persona-selector:hover {
        background: rgba(255, 255, 255, 0.15);
      }
      
      #persona-selector:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.4);
      }
      
      /* ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ìŠ¤íƒ€ì¼ */
      #persona-selector option {
        background: #1f2937 !important; /* ì–´ë‘ìš´ ë°°ê²½ */
        color: #f9fafb !important; /* ë°ì€ ê¸€ì”¨ */
        padding: 8px 12px !important;
        border: none !important;
        font-weight: 500 !important;
      }
      
      #persona-selector option:hover {
        background: #374151 !important; /* í˜¸ë²„ ì‹œ ì¡°ê¸ˆ ë” ë°ê²Œ */
        color: #ffffff !important;
      }
      
      #persona-selector option:checked {
        background: #4f46e5 !important; /* ì„ íƒëœ ì˜µì…˜ì€ ë³´ë¼ìƒ‰ */
        color: #ffffff !important;
      }
      
      /* Firefox ì „ìš© ìŠ¤íƒ€ì¼ */
      @-moz-document url-prefix() {
        #persona-selector option {
          background-color: #1f2937 !important;
          color: #f9fafb !important;
        }
      }
    </style>
  </body>
</html>
